(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const _ of r)if(_.type==="childList")for(const c of _.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function e(r){const _={};return r.integrity&&(_.integrity=r.integrity),r.referrerPolicy&&(_.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?_.credentials="include":r.crossOrigin==="anonymous"?_.credentials="omit":_.credentials="same-origin",_}function o(r){if(r.ep)return;r.ep=!0;const _=e(r);fetch(r.href,_)}})();var y;y||(y={});var O=(s=>(s[s.X=1]="X",s[s.Y=2]="Y",s[s.Z=3]="Z",s))(O||{});const qt=Math.PI/180,te=180/Math.PI;var w;(s=>{s.PI_0_25=.25*Math.PI,s.PI_0_5=.5*Math.PI,s.PI_0_75=.75*Math.PI,s.PI_1_25=1.25*Math.PI,s.PI_1_5=1.5*Math.PI,s.PI_1_75=1.75*Math.PI,s.PI_2=2*Math.PI;function i(c){return c*qt}s.toRadians=i;function e(c){return te*c}s.toDegrees=e;function o(c,T,p){return c*T+(1-c)*p}s.interpolate=o;function r(c,T,p){return Math.max(Math.min(T,p),c)}s.clamp=r;function _(c,T,p){if(c.length<2||T.length<2)throw new Error("Arrays must contain at least two points.");const d=c.length;let m;if(p<c[0])m=0;else if(p>=c[d-1])m=d-2;else for(m=0;m<d-1&&!(p<c[m+1]);m++);const t=(T[m+1]-T[m])/(c[m+1]-c[m]),n=T[m]-t*c[m];return t*p+n}s.interpolateLinear=_})(w||(w={}));var v;(s=>{s.I0J0=0,s.I0J1=1,s.I0J2=2,s.I0J3=3,s.I1J0=4,s.I1J1=5,s.I1J2=6,s.I1J3=7,s.I2J0=8,s.I2J1=9,s.I2J2=10,s.I2J3=11,s.I3J0=12,s.I3J1=13,s.I3J2=14,s.I3J3=15;function i(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}s.createIdentity=i;function e(n,a,l){const u=i();return u[s.I0J0]=n[0],u[s.I0J1]=n[1],u[s.I0J2]=n[2],u[s.I1J0]=a[0],u[s.I1J1]=a[1],u[s.I1J2]=a[2],u[s.I2J0]=l[0],u[s.I2J1]=l[1],u[s.I2J2]=l[2],u}s.createFromVectors=e;function o(n){const[a,l,u,h]=n,f=h*a,I=h*l,g=h*u,R=a*a,x=a*l,S=a*u,N=l*l,V=l*u,M=u*u,L=i();return L[s.I0J0]=1-2*(N+M),L[s.I0J1]=2*(x-g),L[s.I0J2]=2*(S+I),L[s.I1J0]=2*(x+g),L[s.I1J1]=1-2*(R+M),L[s.I1J2]=2*(V-f),L[s.I2J0]=2*(S-I),L[s.I2J1]=2*(V+f),L[s.I2J2]=1-2*(R+N),L}s.createFromQuaternion=o;function r(n,a,l){const u=i();return u[s.I3J0]=n,u[s.I3J1]=a,u[s.I3J2]=l,u}s.createTranslation=r;function _(n,a,l){const u=i();return u[s.I0J0]=n,u[s.I1J1]=a,u[s.I2J2]=l,u}s.createScaling=_;function c(n,a){const l=w.toRadians(n),u=Math.sin(l),h=Math.cos(l),f=i();switch(a){case O.X:f[s.I1J1]=h,f[s.I2J1]=-u,f[s.I1J2]=u,f[s.I2J2]=h;break;case O.Y:f[s.I0J0]=h,f[s.I2J0]=u,f[s.I0J2]=-u,f[s.I2J2]=h;break;case O.Z:f[s.I0J0]=h,f[s.I1J0]=-u,f[s.I0J1]=u,f[s.I1J1]=h;break}return f}s.createRotation=c;function T(n,a){const[l,u,h,f,I,g,R,x,S,N,V,M,L,P,C,D]=n,[b,k,G,X,z,Q,nt,ot,rt,at,st,Tt,B,Lt,Nt,Mt]=a,K=i();return K[s.I0J0]=l*b+u*z+h*rt+f*B,K[s.I0J1]=l*k+u*Q+h*at+f*Lt,K[s.I0J2]=l*G+u*nt+h*st+f*Nt,K[s.I0J3]=l*X+u*ot+h*Tt+f*Mt,K[s.I1J0]=I*b+g*z+R*rt+x*B,K[s.I1J1]=I*k+g*Q+R*at+x*Lt,K[s.I1J2]=I*G+g*nt+R*st+x*Nt,K[s.I1J3]=I*X+g*ot+R*Tt+x*Mt,K[s.I2J0]=S*b+N*z+V*rt+M*B,K[s.I2J1]=S*k+N*Q+V*at+M*Lt,K[s.I2J2]=S*G+N*nt+V*st+M*Nt,K[s.I2J3]=S*X+N*ot+V*Tt+M*Mt,K[s.I3J0]=L*b+P*z+C*rt+D*B,K[s.I3J1]=L*k+P*Q+C*at+D*Lt,K[s.I3J2]=L*G+P*nt+C*st+D*Nt,K[s.I3J3]=L*X+P*ot+C*Tt+D*Mt,K}s.multiply=T;function p(n){return[n[s.I0J0],n[s.I1J0],n[s.I2J0],n[s.I3J0],n[s.I0J1],n[s.I1J1],n[s.I2J1],n[s.I3J1],n[s.I0J2],n[s.I1J2],n[s.I2J2],n[s.I3J2],n[s.I0J3],n[s.I1J3],n[s.I2J3],n[s.I3J3]]}s.transpose=p;function d(n){const[a,l,u,h,f,I,g,R,x,S,N,V,M,L,P,C]=n,D=a*I-l*f,b=a*g-u*f,k=a*R-h*f,G=l*g-u*I,X=l*R-h*I,z=u*R-h*g,Q=x*L-S*M,nt=x*P-N*M,ot=x*C-V*M,rt=S*P-N*L,at=S*C-V*L,st=N*C-V*P,Tt=D*st-b*at+k*rt+G*ot-X*nt+z*Q;if(Tt===0)return;const B=1/Tt;return[(I*st-g*at+R*rt)*B,(-l*st+u*at-h*rt)*B,(L*z-P*X+C*G)*B,(-S*z+N*X-V*G)*B,(-f*st+g*ot-R*nt)*B,(a*st-u*ot+h*nt)*B,(-M*z+P*k-C*b)*B,(x*z-N*k+V*b)*B,(f*at-I*ot+R*Q)*B,(-a*at+l*ot-h*Q)*B,(M*X-L*k+C*D)*B,(-x*X+S*k-V*D)*B,(-f*rt+I*nt-g*Q)*B,(a*rt-l*nt+u*Q)*B,(-M*G+L*b-P*D)*B,(x*G-S*b+N*D)*B]}s.invert=d;function m(n,a){const l=-a[0],u=-a[1],h=-a[2],f=w.toRadians(n),I=Math.cos(f),g=Math.sin(f),R=1-I,x=i();return x[s.I0J0]=I+l*l*R,x[s.I0J1]=l*u*R-h*g,x[s.I0J2]=l*h*R+u*g,x[s.I1J0]=u*l*R+h*g,x[s.I1J1]=I+u*u*R,x[s.I1J2]=u*h*R-l*g,x[s.I2J0]=h*l*R-u*g,x[s.I2J1]=h*u*R+l*g,x[s.I2J2]=I+h*h*R,x}s.createRotationAroundVector=m;function t(n,a,l,u){const h=Math.tan(w.PI_0_5-.5*w.toRadians(n)),f=1/(l-u);return[h/a,0,0,0,0,h,0,0,0,0,(u+l)*f,-1,0,0,2*u*l*f,0]}s.createPerspectiveMatrix=t})(v||(v={}));var mt;(s=>{function i(r,_,c,T=!0){return new Promise((p,d)=>{const m=new Image;m.addEventListener("load",()=>{p(e(m,_,c,T))}),m.addEventListener("error",()=>{d()}),m.src=r})}s.loadFromFile=i;function e(r,_,c,T){const p=c.createTexture();c.bindTexture(c.TEXTURE_2D,p);const d=_?c.REPEAT:c.CLAMP_TO_EDGE;return c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,d),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,d),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,T?c.LINEAR_MIPMAP_LINEAR:c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,r),T&&c.generateMipmap(c.TEXTURE_2D),p}function o(r,_){for(let c=0;c<r.length;c++){const T=r[c];T&&(_.activeTexture(_.TEXTURE0+c),_.bindTexture(_.TEXTURE_2D,T))}}s.bindTextures=o})(mt||(mt={}));var Z;(s=>{function i(T,p,d){const m=e(d.VERTEX_SHADER,T,d),t=e(d.FRAGMENT_SHADER,p,d),n=d.createProgram();if(d.attachShader(n,m),d.attachShader(n,t),d.linkProgram(n),!d.getProgramParameter(n,d.LINK_STATUS)){const l=d.getProgramInfoLog(n);throw d.deleteProgram(n),new Error("Couldn't create program: "+l)}return n}s.loadFromString=i;function e(T,p,d){const m=d.createShader(T);if(d.shaderSource(m,p),d.compileShader(m),!d.getShaderParameter(m,d.COMPILE_STATUS)){const n=d.getShaderInfoLog(m);throw d.deleteShader(m),console.error(p),new Error("Couldn't compile shader. "+n)}return m}function o(T,p,...d){return d.map(m=>r(T,m,p))}s.getUniformLocations=o;function r(T,p,d){const m=d.getUniformLocation(T,p);if(!m)throw new Error("Could not get uniform location: "+p);return m}function _(T,p,...d){return d.map(m=>c(T,m,p))}s.getAttributeLocations=_;function c(T,p,d){const m=d.getAttribLocation(T,p);if(m===-1)throw new Error("Could not get attribute location: "+p);return m}})(Z||(Z={}));var U;(s=>{function i(d,m){m.depthMask(!0),m.clearColor(...d),m.clearStencil(0),m.clear(WebGL2RenderingContext.COLOR_BUFFER_BIT|WebGL2RenderingContext.DEPTH_BUFFER_BIT|WebGL2RenderingContext.STENCIL_BUFFER_BIT)}s.clearRenderContext=i;function e(d,m,t){p(t),t.bufferData(t.ARRAY_BUFFER,new Float32Array(d),t.STATIC_DRAW),t.enableVertexAttribArray(m),t.vertexAttribPointer(m,1,t.FLOAT,!1,0,0)}s.bindTextureIndices=e;function o(d,m,t){p(t),t.bufferData(t.ARRAY_BUFFER,new Float32Array(d),t.STATIC_DRAW),t.enableVertexAttribArray(m),t.vertexAttribPointer(m,3,t.FLOAT,!1,0,0)}s.bindNormals=o;function r(d,m,t){p(t),t.bufferData(t.ARRAY_BUFFER,new Float32Array(d),t.STATIC_DRAW),t.enableVertexAttribArray(m),t.vertexAttribPointer(m,2,t.FLOAT,!1,0,0)}s.bindTextureCoordinates=r;function _(d,m,t=!1){p(m,m.ELEMENT_ARRAY_BUFFER),m.bufferData(m.ELEMENT_ARRAY_BUFFER,t?new Uint32Array(d):new Uint16Array(d),m.STATIC_DRAW)}s.bindIndices=_;function c(d,m,t){p(t),t.bufferData(t.ARRAY_BUFFER,new Float32Array(d),t.STATIC_DRAW),t.enableVertexAttribArray(m),t.vertexAttribPointer(m,3,t.FLOAT,!1,0,0)}s.bindPositions=c;function T(d){const m=d.createVertexArray();if(!m)throw new Error("Could not create vertex array");return d.bindVertexArray(m),m}s.createAndBindVertexArray=T;function p(d,m=WebGL2RenderingContext.ARRAY_BUFFER){const t=d.createBuffer();if(!t)throw new Error("Could not create buffer");return d.bindBuffer(m,t),t}s.createAndBindBuffer=p})(U||(U={}));var A;A||(A={});class H{static VERTEX_SHADER=`#version 300 es
in vec4 a_Position;
in vec2 a_TextureCoordinate;

uniform mat4 u_TransformationMatrix;

out vec2 v_TextureCoordinate;

void main() {
  gl_Position = u_TransformationMatrix * a_Position;
  v_TextureCoordinate = a_TextureCoordinate;
}
`;static FRAGMENT_SHADER=`#version 300 es
precision mediump float;

in vec2 v_TextureCoordinate;

uniform sampler2D u_texture;

out vec4 outColor;
 
void main() {
  outColor = texture(u_texture, v_TextureCoordinate);
}
`;static DELTA=5e-4;static POSITIONS=[-1,-1,-1,1,-1,-1,1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,1,1,1,-1,-1,1,-1,1,1,-1,1,1,1,-1,1,1];static TEXTURE_COORDINATES=[0,1,1/3-H.DELTA,1,1/3-H.DELTA,.5+H.DELTA,0,.5+H.DELTA,0,1/2-H.DELTA,1/3+H.DELTA,1/2-H.DELTA,1/3+H.DELTA,0,0,0,1/3+H.DELTA,1,2/3-H.DELTA,1,2/3-H.DELTA,.5+H.DELTA,1/3+H.DELTA,.5+H.DELTA,2/3+H.DELTA,.5-H.DELTA,1,.5-H.DELTA,1,0,2/3+H.DELTA,0,2/3+H.DELTA,1,1,1,1,.5+H.DELTA,2/3+H.DELTA,.5+H.DELTA];static INDICES=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19];shader;vertexArray;texture;matrixUniformLocation;async init(){const i=y.gl;this.shader=Z.loadFromString(H.VERTEX_SHADER,H.FRAGMENT_SHADER,i),[this.matrixUniformLocation]=Z.getUniformLocations(this.shader,i,"u_TransformationMatrix");const[e,o]=Z.getAttributeLocations(this.shader,i,"a_Position","a_TextureCoordinate");this.vertexArray=U.createAndBindVertexArray(i),U.bindPositions(H.POSITIONS,e,i),U.bindIndices(H.INDICES,i),U.bindTextureCoordinates(H.TEXTURE_COORDINATES,o,i),this.texture=await mt.loadFromFile(`assets/skybox/${A.environment.skyboxTexture}`,!1,i,!1)}draw(){y.modelViewMatrix.push(),y.modelViewMatrix.multiply(v.createTranslation(...y.cameraPosition));const i=v.multiply(y.modelViewMatrix.current,y.perspectiveMatrix),e=y.gl;e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.depthMask(!1),e.disable(e.BLEND),e.useProgram(this.shader),e.uniformMatrix4fv(this.matrixUniformLocation,!1,i),e.bindVertexArray(this.vertexArray),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.texture),e.drawElements(e.TRIANGLES,H.INDICES.length,e.UNSIGNED_SHORT,0),y.modelViewMatrix.pop()}}var E;(s=>{s.X_UNIT=[1,0,0],s.Y_UNIT=[0,1,0],s.Z_UNIT=[0,0,1],s.NEGATIVE_X_UNIT=[-1,0,0],s.NEGATIVE_Y_UNIT=[0,-1,0],s.NEGATIVE_Z_UNIT=[0,0,-1],s.ZERO=[0,0,0];function i(u,h){return u[0]*h[0]+u[1]*h[1]+u[2]*h[2]}s.computeDotProduct=i;function e(u){return Math.hypot(...u)}s.computeLength=e;function o(u){return[-u[0],-u[1],-u[2]]}s.negate=o;function r(u,h){return[u*h[0],u*h[1],u*h[2]]}s.multiply=r;function _(u){const h=e(u);return h==0?s.ZERO:r(1/h,u)}s.normalize=_;function c(u,h){return[u[0]-h[0],u[1]-h[1],u[2]-h[2]]}s.subtract=c;function T(u,h){return[u[0]+h[0],u[1]+h[1],u[2]+h[2]]}s.add=T;function p(...u){const h=[0,0,0];return u.forEach(f=>{h[0]+=f[0],h[1]+=f[1],h[2]+=f[2]}),h}s.addAll=p;function d(u,h){const f=i(u,h);return c(h,r(f,u))}s.projectToPlane=d;function m(u,h){const[f,I,g]=u,[R,x,S]=h;return[I*S-g*x,g*R-f*S,f*x-I*R]}s.computeCrossProduct=m;function t(u,h,f){return[w.interpolate(u,h[0],f[0]),w.interpolate(u,h[1],f[1]),w.interpolate(u,h[2],f[2])]}s.interpolate=t;function n(u,h){const[f,I,g,,R,x,S,,N,V,M,,L,P,C]=u,[D,b,k]=h;return[D*f+b*R+k*N+L,D*I+b*x+k*V+P,D*g+b*S+k*M+C]}s.transformPoint=n;function a(u,h){const[f,I,g,,R,x,S,,N,V,M]=u,[L,P,C]=h;return[L*f+P*R+C*N,L*I+P*x+C*V,L*g+P*S+C*M]}s.transformVector=a;function l(u,h){const f=[u[0],u[1],u[2]],I=u[3],g=s.multiply(2,s.computeCrossProduct(f,h));return s.add(s.add(h,s.multiply(I,g)),s.computeCrossProduct(f,g))}s.rotateVector=l})(E||(E={}));var yt=(s=>(s[s.ABOVE=1]="ABOVE",s[s.FOLLOWING=2]="FOLLOWING",s))(yt||{}),ct;(s=>{function i(p){const[d,m,t,,n,a,l,,u,h,f,,,]=p,I=d+a+f;let g,R,x,S;if(I>0){const N=Math.sqrt(I+1)*2;S=.25*N,g=(h-l)/N,R=(t-u)/N,x=(n-m)/N}else if(d>a&&d>f){const N=Math.sqrt(1+d-a-f)*2;S=(h-l)/N,g=.25*N,R=(m+n)/N,x=(t+u)/N}else if(a>f){const N=Math.sqrt(1+a-d-f)*2;S=(t-u)/N,g=(m+n)/N,R=.25*N,x=(l+h)/N}else{const N=Math.sqrt(1+f-d-a)*2;S=(n-m)/N,g=(t+u)/N,R=(l+h)/N,x=.25*N}return[g,R,x,S]}s.createFromRotationMatrix=i;function e(p,d){const m=E.computeCrossProduct(p,d);if(E.computeLength(m)<Number.EPSILON)return[0,0,0,1];{const n=E.computeDotProduct(p,d),a=Math.sqrt((1-n)/2),l=Math.sqrt((1+n)/2);return[a*m[0],a*m[1],a*m[2],l]}}s.createFromVectors=e;function o(p){const d=E.normalize(E.negate(p)),m=E.normalize(E.projectToPlane(d,E.Y_UNIT)),t=E.computeCrossProduct(m,d);return s.createFromRotationMatrix(v.createFromVectors(t,m,d))}s.createLookRotationFromDirection=o;function r(p,d,m){let t=c(p,d);t<0&&(t=-t,d=T(d));let n,a;if(1-t>Number.EPSILON){const l=Math.acos(t),u=Math.sin(l);n=Math.sin(l*(1-m))/u,a=Math.sin(l*m)/u}else n=1-m,a=m;return[n*p[0]+a*d[0],n*p[1]+a*d[1],n*p[2]+a*d[2],n*p[3]+a*d[3]]}s.interpolate=r;function _(p){return[-p[0],-p[1],-p[2],p[3]]}s.conjugate=_;function c(p,d){return p[0]*d[0]+p[1]*d[1]+p[2]*d[2]+p[3]*d[3]}function T(p){return[-p[0],-p[1],-p[2],-p[3]]}})(ct||(ct={}));class Y{static CAMERA_ANGLE_ABOVE_SLOPE=10;static PLAYER_ANGLE_IN_CAMERA=20;static MIN_CAMERA_HEIGHT=1.5;static ABSOLUTE_MIN_CAMERA_HEIGHT=.3;static PLAYER_CAMERA_DISTANCE=4;static MAX_INTERPOLATION_VALUE=.3;static MAX_CAMERA_PITCH=40;static FOLLOW_ORBIT_TIME_CONSTANT=.06;static FOLLOW_ORIENT_TIME_CONSTANT=.06;static NO_INTERPOLATION_SPEED=2;static BASELINE_INTERPOLATION_SPEED=4.5;static CAMERA_DISTANCE_INCREMENT=2;playerDistance;position;direction;viewVector;viewMode;constructor(){this.playerDistance=Y.PLAYER_CAMERA_DISTANCE,this.viewMode=yt.ABOVE,this.direction=E.NEGATIVE_Z_UNIT,this.position=E.ZERO}init(){this.viewVector=this.createViewVector()}incrementCameraDistance(i){this.playerDistance+=i*Y.CAMERA_DISTANCE_INCREMENT}update(i){this.viewMode===yt.ABOVE?this.updateAboveView():this.viewMode===yt.FOLLOWING&&this.updateFollowingView(i),this.applyViewMatrix()}updateFollowingView(i){const e=E.normalize(A.player.velocity),o=E.normalize(E.projectToPlane(e,E.Y_UNIT)),r=ct.createFromVectors(E.NEGATIVE_Z_UNIT,o);let _=E.rotateVector(r,this.viewVector),c=E.add(A.player.position,_),T=A.course.findYPosition(c[0],c[2]);c[1]=Math.max(c[1],T+Y.MIN_CAMERA_HEIGHT);const p=(A.player.speed-Y.NO_INTERPOLATION_SPEED)/(Y.BASELINE_INTERPOLATION_SPEED-Y.NO_INTERPOLATION_SPEED),d=Y.FOLLOW_ORBIT_TIME_CONSTANT*(1/w.clamp(0,p,1));c=this.interpolateCameraPosition(c,i,d),c=this.interpolateCameraPosition(c,i,d),T=A.course.findYPosition(c[0],c[2]),c[1]=Math.max(c[1],T+Y.ABSOLUTE_MIN_CAMERA_HEIGHT),_=E.subtract(c,A.player.position);const m=E.normalize(E.computeCrossProduct(E.Y_UNIT,_)),t=v.createRotationAroundVector(Y.PLAYER_ANGLE_IN_CAMERA,m);let n=E.negate(E.transformVector(t,_));n=this.interpolateCameraFrame(n,i),n=this.interpolateCameraFrame(n,i),this.position=c,this.direction=n}updateAboveView(){this.position=E.add(A.player.position,this.viewVector);const i=A.course.findYPosition(this.position[0],this.position[2]);this.position[1]=Math.max(this.position[1],i+Y.MIN_CAMERA_HEIGHT);const e=E.subtract(this.position,A.player.position),o=v.createRotation(Y.PLAYER_ANGLE_IN_CAMERA,O.X);this.direction=E.negate(E.transformVector(o,e))}interpolateCameraFrame(i,e){const o=ct.createLookRotationFromDirection(this.direction),r=ct.createLookRotationFromDirection(i),_=Math.min(Y.MAX_INTERPOLATION_VALUE,1-Math.exp(-e/Y.FOLLOW_ORIENT_TIME_CONSTANT)),c=ct.interpolate(o,r,_),T=v.createFromQuaternion(c);return[-T[v.I2J0],-T[v.I2J1],-T[v.I2J2]]}interpolateCameraPosition(i,e,o){const r=A.player.lastPosition?E.normalize(E.subtract(this.position,A.player.lastPosition)):E.ZERO,_=E.normalize(E.subtract(i,A.player.position)),c=ct.createFromVectors(E.Y_UNIT,r),T=ct.createFromVectors(E.Y_UNIT,_),p=Math.min(Y.MAX_INTERPOLATION_VALUE,1-Math.exp(-e/o)),d=ct.interpolate(c,T,p);let m=E.rotateVector(d,E.Y_UNIT);const t=w.toDegrees(w.PI_0_5-Math.acos(E.computeDotProduct(m,E.Y_UNIT)));if(t>Y.MAX_CAMERA_PITCH){const n=E.normalize(E.computeCrossProduct(E.Y_UNIT,m)),a=t-Y.MAX_CAMERA_PITCH,l=v.createRotationAroundVector(a,n);m=E.transformVector(l,m)}return E.add(A.player.position,E.multiply(this.playerDistance,m))}applyViewMatrix(){const i=E.normalize(E.negate(this.direction)),e=E.normalize(E.computeCrossProduct(E.Y_UNIT,i)),o=E.computeCrossProduct(i,e),r=-E.computeDotProduct(this.position,e),_=-E.computeDotProduct(this.position,o),c=-E.computeDotProduct(this.position,i),T=[e[0],o[0],i[0],0,e[1],o[1],i[1],0,e[2],o[2],i[2],0,r,_,c,1];y.modelViewMatrix.load(T),y.viewMatrix=T,y.cameraPosition=this.position}createViewVector(){const i=A.courseConfig.angle-Y.CAMERA_ANGLE_ABOVE_SLOPE+Y.PLAYER_ANGLE_IN_CAMERA,e=w.toRadians(i);return[0,this.playerDistance*Math.sin(e),this.playerDistance*Math.cos(e)]}}class St{width;height;data;constructor(i,e,o){this.width=i,this.height=e,this.data=o}static loadFromFile(i,e=!1){return new Promise((o,r)=>{const _=new Image;_.addEventListener("load",()=>{o(St.createBitmap(_,e))}),_.addEventListener("error",()=>{r()}),_.src=i})}static createBitmap(i,e){const o=new OffscreenCanvas(i.width,i.height),r=o.getContext("2d");r.drawImage(i,0,0);const _=r.getImageData(0,0,o.width,o.height),{data:c}=_,T=[];for(let p=0;p<c.length;p+=4){const d=c[p],m=c[p+1],t=c[p+2],n=e?Math.round((d+m+t)/3):(d<<16)+(m<<8)+t;T.push(n)}return new St(o.width,o.height,T)}}var _t;(s=>{const i=`
vec3 computeLight(in vec3 eyeNormal, in vec3 viewDirection, in vec3 lightDirection, in vec3 ambientColor, in vec3 diffuseColor, in vec3 specularColor) {
  vec3 eyeLightDirection = normalize(mat3(u_ViewMatrix) * lightDirection);
  
  float diffuseFactor = max(dot(eyeNormal, eyeLightDirection), 0.0);
  
  vec3 halfwayDirection = normalize(eyeLightDirection + viewDirection);
  float specularFactor = pow(max(dot(eyeNormal, halfwayDirection), 0.0), $$specular-exponent$$);

  return $$light-terms-sum$$;
}
  `,e=`
vec3 computeAllLights(in vec4 eyePosition) {
  mat3 normalMatrix = $$normal-matrix$$;
  vec3 eyeNormal = normalize(normalMatrix * $$normal-expression$$);
  
  vec3 viewDirection = normalize(-eyePosition.xyz);

  $$light-color-assignments$$
  
  return clamp($$light-color-sum$$, 0.0, 1.0);
}
  `,o=`
float computeFogFactor(in vec4 eyePosition) {
  float distance = length(eyePosition.xyz);
  return clamp((distance - $$fog-start$$) / $$fog-length$$, 0.0, 1.0);
}
  `,r=`
vec4 computeFinalColor(in vec4 color) {
  vec4 colorWithLight = vec4(color.rgb * v_LightColor, color.a);
  return mix(colorWithLight, $$fog-color$$, v_FogFactor);
}
  `;function _(l,u,h,f){const I=p(h)+d(h)+T();return l=a(l,new Map([["lighting-function",I]])),u=a(u,new Map([["lighting-function",c()]])),Z.loadFromString(l,u,f)}s.createShader=_;function c(){return a(r,new Map([["fog-color",m(...A.environment.fog.color)]]))}function T(){const l=A.environment.fog.end-A.environment.fog.start;return a(o,new Map([["fog-start",n(A.environment.fog.start)],["fog-length",n(l)]]))}function p(l){return l.useMaterial?a(i,new Map([["light-terms-sum","(ambientColor * u_MaterialDiffuseColor) + diffuseFactor * (diffuseColor * u_MaterialDiffuseColor) + specularFactor * (specularColor * u_MaterialSpecularColor)"],["specular-exponent","u_MaterialSpecularExponent"]])):a(i,new Map([["light-terms-sum","ambientColor + diffuseFactor * diffuseColor + specularFactor * specularColor"],["specular-exponent","SPECULAR_EXPONENT"]]))}function d(l){let u="";const h=[];for(let f=0;f<A.environment.lights.length;f++){const I=A.environment.lights[f],g=`light${f}Color`;u+=`vec3 ${g} = computeLight(eyeNormal, viewDirection, ${t(...I.position)}, ${t(...I.ambientColor)}, ${t(...I.diffuseColor)}, ${t(...I.specularColor)});
`,h.push(g)}return a(e,new Map([["light-color-assignments",u],["light-color-sum",h.join(" + ")],["normal-expression",l.useStaticNormal?"NORMAL":"a_Normal"],["normal-matrix",l.useNormalMatrix?"mat3(u_NormalMatrix)":"mat3(u_ModelViewMatrix)"]]))}function m(l,u,h,f){return`vec4(${n(l)}, ${n(u)}, ${n(h)}, ${n(f)})`}s.toVec4=m;function t(l,u,h,f){return`vec3(${n(l)}, ${n(u)}, ${n(h)})`}s.toVec3=t;function n(l){return l.toFixed(2)}s.toFloat=n;function a(l,u){let h=l;return u.forEach((f,I)=>{const g=`$$${I}$$`;h=h.replaceAll(g,f)}),h}s.replacePlaceholders=a})(_t||(_t={}));class wt{static VERTEX_SHADER=`#version 300 es

#define SPECULAR_EXPONENT 1.0
#define TEXTURE_SCALE 6.0

in vec4 a_Position;
in vec3 a_Normal;
in float a_TextureIndex;

uniform mat4 u_ModelViewMatrix;
uniform mat4 u_ViewMatrix;
uniform mat4 u_ProjectionMatrix;

out vec3 v_LightColor;
out float v_FogFactor;
out vec2 v_TextureCoordinate;
out vec3 v_TextureWeights;

$$lighting-function$$

void setTextureWeights() {
  uint index = uint(a_TextureIndex);
  v_TextureWeights = vec3(0.0);
  v_TextureWeights[index] = 1.0;
}

void main() {
  vec4 eyePosition = u_ModelViewMatrix * a_Position;
  gl_Position = u_ProjectionMatrix * eyePosition;

  v_LightColor = computeAllLights(eyePosition);
  v_FogFactor = computeFogFactor(eyePosition);

  v_TextureCoordinate = vec2(
    a_Position.x / TEXTURE_SCALE,
    a_Position.z / TEXTURE_SCALE
  );

  setTextureWeights();
}
`;static FRAGMENT_SHADER=`#version 300 es
#define NUM_TEXTURES 3

precision mediump float;
  
in vec3 v_LightColor;
in float v_FogFactor;
in vec2 v_TextureCoordinate;
in vec3 v_TextureWeights;

uniform sampler2D u_Textures[NUM_TEXTURES];

out vec4 outColor;

$$lighting-function$$

vec4 getTextureColor() {
  vec4 color = vec4(0.0);
  if (v_TextureWeights[0] > 0.0) {
    color += texture(u_Textures[0], v_TextureCoordinate) * v_TextureWeights[0];
  }
  if (v_TextureWeights[1] > 0.0) {
    color += texture(u_Textures[1], v_TextureCoordinate) * v_TextureWeights[1];
  }
  if (v_TextureWeights[2] > 0.0) {
    color += texture(u_Textures[2], v_TextureCoordinate) * v_TextureWeights[2];
  }
  return color;
}

void main() {
  vec4 textureColor = getTextureColor();
  outColor = computeFinalColor(textureColor);
}
`;static SHADER_LIGHT_SETTINGS={useMaterial:!1,useStaticNormal:!1,useNormalMatrix:!1};shader;vertexArray;numIndices;textures;textureMapping;viewMatrixUniformLocation;modelViewMatrixUniformLocation;projectionMatrixUniformLocation;texturesUniformLocation;async init(i,e,o){const r=y.gl;this.shader=_t.createShader(wt.VERTEX_SHADER,wt.FRAGMENT_SHADER,wt.SHADER_LIGHT_SETTINGS,r),[this.viewMatrixUniformLocation,this.modelViewMatrixUniformLocation,this.projectionMatrixUniformLocation,this.texturesUniformLocation]=Z.getUniformLocations(this.shader,r,"u_ViewMatrix","u_ModelViewMatrix","u_ProjectionMatrix","u_Textures");const[_,c,T]=Z.getAttributeLocations(this.shader,r,"a_Position","a_Normal","a_TextureIndex"),p=o.map(n=>n.point).flat(),d=o.map(n=>n.normal).flat(),m=o.map(n=>n.terrain.glId),t=this.generateIndices(i,e);this.numIndices=t.length,this.vertexArray=U.createAndBindVertexArray(r),U.bindPositions(p,_,r),U.bindIndices(t,r,!0),U.bindNormals(d,c,r),U.bindTextureIndices(m,T,r),this.textures=await this.loadTerrainTextures(o,r),this.textureMapping=[...this.textures.keys()]}draw(){const i=y.gl;i.enable(i.CULL_FACE),i.enable(i.DEPTH_TEST),i.depthFunc(i.LEQUAL),i.depthMask(!0),i.disable(i.BLEND),i.useProgram(this.shader),i.uniformMatrix4fv(this.viewMatrixUniformLocation,!1,y.viewMatrix),i.uniformMatrix4fv(this.modelViewMatrixUniformLocation,!1,y.modelViewMatrix.current),i.uniformMatrix4fv(this.projectionMatrixUniformLocation,!1,y.perspectiveMatrix),i.uniform1iv(this.texturesUniformLocation,this.textureMapping),i.bindVertexArray(this.vertexArray),mt.bindTextures(this.textures,i),i.drawElements(i.TRIANGLES,this.numIndices,i.UNSIGNED_INT,0)}generateIndices(i,e){const o=[];for(let r=0;r<e-1;r++)for(let _=0;_<i-1;_++)o.push(_+r*i),o.push(_+1+r*i),o.push(_+(r+1)*i),o.push(_+1+r*i),o.push(_+1+(r+1)*i),o.push(_+(r+1)*i);return o}async loadTerrainTextures(i,e){const o=[],r=new Set(i.map(_=>_.terrain));for(const _ of r.values())o[_.glId]=mt.loadFromFile(`assets/terrain/${_.texture}`,!0,e);return await Promise.all(o)}}class Xt{static NORMAL_INTERPOLATION=.05;numFieldsX;numFieldsY;fields;renderer;constructor(i,e,o){this.numFieldsX=i,this.numFieldsY=e,this.fields=o,this.renderer=new wt}async init(){await this.renderer.init(this.numFieldsX,this.numFieldsY,this.fields)}draw(){this.renderer.draw()}findYPosition(i,e){const o=this.getIndicesForPoint(i,e),[r,_]=this.findBarycentricCoords(i,e,o),c=this.getVertex(o[0][0],o[0][1]),T=this.getVertex(o[1][0],o[1][1]),p=this.getVertex(o[2][0],o[2][1]);return r*c[1]+_*T[1]+(1-r-_)*p[1]}findNormal(i,e){const o=this.getIndicesForPoint(i,e),[r,_]=this.findBarycentricCoords(i,e,o),c=1-r-_,T=this.getNormal(o[0][0],o[0][1]),p=this.getNormal(o[1][0],o[1][1]),d=this.getNormal(o[2][0],o[2][1]),m=this.getVertex(o[0][0],o[0][1]),t=this.getVertex(o[1][0],o[1][1]),n=this.getVertex(o[2][0],o[2][1]),a=E.add(E.multiply(r,T),E.add(E.multiply(_,p),E.multiply(c,d))),l=E.normalize(E.computeCrossProduct(E.subtract(t,m),E.subtract(n,m))),u=Math.min(r,_,c),h=Math.min(u/Xt.NORMAL_INTERPOLATION,1);return E.normalize(E.add(E.multiply(h,l),E.multiply(1-h,a)))}findPlane(i,e){const o=this.findYPosition(i,e),r=this.findNormal(i,e),_=-E.computeDotProduct(r,[i,o,e]);return{normal:r,distance:_}}findFrictionAndDepth(i,e){const o=this.getIndicesForPoint(i,e),[r,_]=this.findBarycentricCoords(i,e,o),c=1-r-_,T=this.getTerrain(o[0][0],o[0][1]),p=this.getTerrain(o[1][0],o[1][1]),d=this.getTerrain(o[2][0],o[2][1]),m=r*T.friction+_*p.friction+c*d.friction,t=r*T.depth+_*p.depth+c*d.depth;return[m,t]}findTerrain(i,e){const o=this.getIndicesForPoint(i,e),[r,_]=this.findBarycentricCoords(i,e,o),c=1-r-_;return r>=_&&r>=c?this.getTerrain(o[0][0],o[0][1]):_>=r&&_>=c?this.getTerrain(o[1][0],o[1][1]):this.getTerrain(o[2][0],o[2][1])}canHaveTrackMarks(i,e){const o=this.getIndicesForPoint(i,e),[r,_]=this.findBarycentricCoords(i,e,o),c=this.getTerrain(o[0][0],o[0][1]),T=this.getTerrain(o[1][0],o[1][1]),p=this.getTerrain(o[2][0],o[2][1]);let d=c.hasTrackmarks?r:0;return d+=T.hasTrackmarks?_:0,d+=p.hasTrackmarks?1-r-_:0,d>=.5}getVertex(i,e){return this.fields[i+this.numFieldsX*e].point}getNormal(i,e){return this.fields[i+this.numFieldsX*e].normal}getTerrain(i,e){return this.fields[i+this.numFieldsX*e].terrain}findBarycentricCoords(i,e,o){const r=i/A.courseConfig.width*(this.numFieldsX-1),_=-e/A.courseConfig.length*(this.numFieldsY-1),c=o[0][0]-o[2][0],T=o[0][1]-o[2][1],p=o[1][0]-o[2][0],d=o[1][1]-o[2][1],m=r-o[2][0],t=_-o[2][1],n=1/(c*d-T*p),a=(m*d-t*p)*n,l=(t*c-m*T)*n;return[a,l]}getIndicesForPoint(i,e){const o=i/A.courseConfig.width*(this.numFieldsX-1),r=-e/A.courseConfig.length*(this.numFieldsY-1),_=w.clamp(0,o,this.numFieldsX-1),c=w.clamp(0,r,this.numFieldsY-1);let T=Math.floor(_),p=Math.ceil(_),d=Math.floor(c),m=Math.ceil(c);return T===p&&(p<this.numFieldsX-1?p++:T--),d===m&&(m<this.numFieldsY-1?m++:d--),(T+d)%2===0?r-d<o-T?[[T,d],[p,d],[p,m]]:[[p,m],[T,m],[T,d]]:r-d+o-T<1?[[T,d],[p,d],[T,m]]:[[p,m],[T,m],[p,d]]}}var it=(s=>(s[s.PICKUP_1=1]="PICKUP_1",s[s.PICKUP_2=2]="PICKUP_2",s[s.PICKUP_3=3]="PICKUP_3",s[s.TREE_HIT=4]="TREE_HIT",s[s.TERRAIN_GRASS=5]="TERRAIN_GRASS",s[s.TERRAIN_ICE=6]="TERRAIN_ICE",s[s.TERRAIN_LEAVES=7]="TERRAIN_LEAVES",s[s.TERRAIN_MUD=8]="TERRAIN_MUD",s[s.TERRAIN_ROCK=9]="TERRAIN_ROCK",s[s.TERRAIN_SNOW=10]="TERRAIN_SNOW",s))(it||{}),Ut;(s=>{const i={texture:"ice.webp",glId:0,friction:.2,depth:.03,hasTrackmarks:!1,sound:it.TERRAIN_ICE},e={texture:"snow.webp",glId:2,friction:.35,depth:.11,hasTrackmarks:!0,sound:it.TERRAIN_SNOW},o={texture:"rock.webp",glId:1,friction:.7,depth:.01,hasTrackmarks:!1,sound:it.TERRAIN_ROCK};function r(_){const c=_>>16&255;return c<45?i:c>205?e:o}s.findMatchingTerrain=r})(Ut||(Ut={}));var Ht;(s=>{async function e(){const c=await St.loadFromFile(`assets/course/${A.courseConfig.key}/elevation.png`,!0),T=await St.loadFromFile(`assets/course/${A.courseConfig.key}/terrain.png`),p=c.width,d=c.height,m=Math.tan(w.toRadians(A.courseConfig.angle)),t=[];for(let n=0;n<d;n++)for(let a=0;a<p;a++){const l=p-a-1+n*p,h=(c.data[l]-127)/255*A.courseConfig.scale-n/d*A.courseConfig.length*m,f=a/(p-1)*A.courseConfig.width,I=-n/(d-1)*A.courseConfig.length,g=[f,h,I],R=T.data[l],x=Ut.findMatchingTerrain(R);t[a+n*p]={point:g,terrain:x}}return o(t,p,d),new Xt(p,d,t)}s.load=e;function o(c,T,p){for(let d=0;d<p;d++)for(let m=0;m<T;m++){let t=E.ZERO;const n=_(c,m,d,T);(m+d)%2===0?(m>0&&d>0&&(t=r(n,_(c,m,d-1,T),_(c,m-1,d-1,T),t),t=r(n,_(c,m-1,d-1,T),_(c,m-1,d,T),t)),m>0&&d<p-1&&(t=r(n,_(c,m-1,d,T),_(c,m-1,d+1,T),t),t=r(n,_(c,m-1,d+1,T),_(c,m,d+1,T),t)),m<T-1&&d>0&&(t=r(n,_(c,m+1,d,T),_(c,m+1,d-1,T),t),t=r(n,_(c,m+1,d-1,T),_(c,m,d-1,T),t)),m<T-1&&d<p-1&&(t=r(n,_(c,m+1,d,T),_(c,m+1,d+1,T),t),t=r(n,_(c,m+1,d+1,T),_(c,m,d+1,T),t))):(m>0&&d>0&&(t=r(n,_(c,m,d-1,T),_(c,m-1,d,T),t)),m>0&&d<p-1&&(t=r(n,_(c,m-1,d,T),_(c,m,d+1,T),t)),m<T-1&&d>0&&(t=r(n,_(c,m+1,d,T),_(c,m,d-1,T),t)),m<T-1&&d<p-1&&(t=r(n,_(c,m+1,d,T),_(c,m,d+1,T),t))),c[m+d*T].normal=E.normalize(t)}}function r(c,T,p,d){const m=E.subtract(T,c),t=E.subtract(p,c),n=E.normalize(E.computeCrossProduct(t,m));return E.add(d,n)}function _(c,T,p,d){return c[T+d*p].point}})(Ht||(Ht={}));class Yt{vertices;normals;indices;constructor(i,e,o){this.vertices=i,this.normals=e,this.indices=o}static generate(i,e,o){const r=[],_=[],c=[];for(let T=0;T<=o;T++){const p=Math.PI/o*T,d=Math.sin(p),m=Math.cos(p);for(let t=0;t<=e;t++){const n=w.PI_2/e*t,a=Math.sin(n),l=Math.cos(n),u=i*d*l,h=i*d*a,f=i*m,I=d*l,g=d*a,R=m;r.push(u,h,f),_.push(I,g,R)}}for(let T=0;T<o;T++)for(let p=0;p<e;p++){const d=T*(e+1)+p,m=d+e+1;c.push(d,m,d+1),c.push(m,m+1,d+1)}return new Yt(r,_,c)}}class ht{static MIN_SPHERE_DIVISIONS=3;static MAX_SPHERE_DIVISIONS=16;static VERTEX_SHADER=`#version 300 es
in vec4 a_Position;
in vec3 a_Normal;

uniform mat4 u_ModelViewMatrix;
uniform mat4 u_ViewMatrix;
uniform mat4 u_ProjectionMatrix;
uniform mat4 u_NormalMatrix;
uniform vec3 u_MaterialDiffuseColor;
uniform vec3 u_MaterialSpecularColor;
uniform float u_MaterialSpecularExponent;

out vec3 v_LightColor;

$$lighting-function$$

void main() {
  vec4 eyePosition = u_ModelViewMatrix * a_Position;
  gl_Position = u_ProjectionMatrix * eyePosition;

  v_LightColor = computeAllLights(eyePosition);
}
`;static FRAGMENT_SHADER=`#version 300 es
precision mediump float;
  
in vec3 v_LightColor;

out vec4 outColor;

void main() {
  outColor = vec4(v_LightColor, 1.0);
}
`;static SHADER_LIGHT_SETTINGS={useMaterial:!0,useStaticNormal:!1,useNormalMatrix:!0};renderingInfo;shader;viewMatrixUniformLocation;modelViewMatrixUniformLocation;projectionMatrixUniformLocation;normalMatrixUniformLocation;materialDiffuseColorUniformLocation;materialSpecularColorUniformLocation;materialSpecularExponentUniformLocation;constructor(){this.renderingInfo=new Map}async init(){const i=y.gl;this.shader=_t.createShader(ht.VERTEX_SHADER,ht.FRAGMENT_SHADER,ht.SHADER_LIGHT_SETTINGS,i),[this.viewMatrixUniformLocation,this.modelViewMatrixUniformLocation,this.projectionMatrixUniformLocation,this.normalMatrixUniformLocation,this.materialDiffuseColorUniformLocation,this.materialSpecularColorUniformLocation,this.materialSpecularExponentUniformLocation]=Z.getUniformLocations(this.shader,i,"u_ViewMatrix","u_ModelViewMatrix","u_ProjectionMatrix","u_NormalMatrix","u_MaterialDiffuseColor","u_MaterialSpecularColor","u_MaterialSpecularExponent");const[e,o]=Z.getAttributeLocations(this.shader,i,"a_Position","a_Normal");for(let r=ht.MIN_SPHERE_DIVISIONS;r<=ht.MAX_SPHERE_DIVISIONS;r++){const _=Yt.generate(1,2*r,r),c=U.createAndBindVertexArray(i);U.bindPositions(_.vertices,e,i),U.bindIndices(_.indices,i),U.bindNormals(_.normals,o,i),this.renderingInfo.set(r,{numIndices:_.indices.length,vertexArray:c})}}prepareDrawing(){const i=y.gl;i.enable(i.CULL_FACE),i.enable(i.DEPTH_TEST),i.depthFunc(i.LESS),i.depthMask(!0),i.disable(i.BLEND),i.useProgram(this.shader),i.uniformMatrix4fv(this.projectionMatrixUniformLocation,!1,y.perspectiveMatrix),i.uniformMatrix4fv(this.viewMatrixUniformLocation,!1,y.viewMatrix)}draw(i){if(!i.isVisible||!i.material||!i.numSphereDivisions)return;const e=this.renderingInfo.get(i.numSphereDivisions),o=y.gl;o.uniformMatrix4fv(this.modelViewMatrixUniformLocation,!1,y.modelViewMatrix.current),o.uniformMatrix4fv(this.normalMatrixUniformLocation,!0,v.invert(y.modelViewMatrix.current)??y.modelViewMatrix.current),o.uniform3fv(this.materialDiffuseColorUniformLocation,i.material.diffuseColor),o.uniform3fv(this.materialSpecularColorUniformLocation,i.material.specularColor),o.uniform1f(this.materialSpecularExponentUniformLocation,i.material.specularExponent),o.bindVertexArray(e.vertexArray),o.drawElements(o.TRIANGLE_STRIP,e.numIndices,o.UNSIGNED_SHORT,0)}}class ee{hierarchyMap;rootNode;nodeRenderer;constructor(i,e){this.hierarchyMap=i,this.rootNode=e,this.nodeRenderer=new ht}async init(){await this.nodeRenderer.init()}draw(i){this.nodeRenderer.prepareDrawing(),this.drawNode(this.rootNode,i)}drawNode(i,e){y.modelViewMatrix.push(),y.modelViewMatrix.multiply(this.getNodeTransformation(i,e)),i.isVisible&&this.nodeRenderer.draw(i);const o=this.hierarchyMap.get(i);o&&o.forEach(r=>{this.drawNode(r,e)}),y.modelViewMatrix.pop()}getNodeTransformation(i,e){return e&&i.joint?e.get(i.joint)??i.transformation:i.transformation}}var F=(s=>(s[s.ROOT=1]="ROOT",s[s.NECK=2]="NECK",s[s.HEAD=3]="HEAD",s[s.LEFT_SHOULDER=4]="LEFT_SHOULDER",s[s.RIGHT_SHOULDER=5]="RIGHT_SHOULDER",s[s.LEFT_HIP=6]="LEFT_HIP",s[s.RIGHT_HIP=7]="RIGHT_HIP",s[s.LEFT_KNEE=8]="LEFT_KNEE",s[s.RIGHT_KNEE=9]="RIGHT_KNEE",s[s.LEFT_ANKLE=10]="LEFT_ANKLE",s[s.RIGHT_ANKLE=11]="RIGHT_ANKLE",s[s.LEFT_ELBOW=12]="LEFT_ELBOW",s[s.RIGHT_ELBOW=13]="RIGHT_ELBOW",s[s.LEFT_HAND=14]="LEFT_HAND",s[s.RIGHT_HAND=15]="RIGHT_HAND",s[s.TAIL=16]="TAIL",s))(F||{}),Gt;(s=>{let i;(a=>{a[a.TRANS=1]="TRANS",a[a.ROT_X=2]="ROT_X",a[a.ROT_Y=3]="ROT_Y",a[a.ROT_YZ=4]="ROT_YZ",a[a.ROT_Z=5]="ROT_Z",a[a.SCL=6]="SCL"})(i||(i={}));async function e(a){const u=await(await fetch(`assets/character/${a}/character.json`)).json(),h=n(u.materials),f=r(u.nodes,h),I=o(f),g=f.get(0);return new ee(I,g)}s.load=e;function o(a){const l=new Map;return a.forEach(u=>{if(!u.parent)return;l.has(u.parent)||l.set(u.parent,[]),l.get(u.parent).push(u)}),l}function r(a,l){const u=new Map;return u.set(0,_()),a.forEach(h=>{const f=u.get(h.parentId);u.set(h.id,c(h,f,l))}),u}function _(){return{joint:F.ROOT,isVisible:!1,hasShadow:!1,numSphereDivisions:0,transformation:v.createIdentity()}}function c(a,l,u){return{parent:l,material:m(a,u),joint:d(a),isVisible:p(a),hasShadow:!!a.shadow,numSphereDivisions:T(a),transformation:t(a)}}function T(a){if(a.visibility)return w.clamp(ht.MIN_SPHERE_DIVISIONS,a.visibility,ht.MAX_SPHERE_DIVISIONS)}function p(a){return a.visibility?a.visibility>0:!1}function d(a){if(!a.joint)return;const l=F[a.joint];if(!l)throw new Error(`Unknown joint: ${a.joint}`);return l}function m(a,l){if(!a.material)return;const u=l.get(a.material);if(!u)throw new Error(`Unknown material: ${a.material}`);return u}function t(a){let l=v.createIdentity();if(!a.transformationOrder)return l;const u=a.translation??E.ZERO,h=a.scale??E.ZERO,f=a.rotation??E.ZERO;return a.transformationOrder.map(I=>i[I]).map(I=>{switch(I){case 1:return v.createTranslation(...u);case 6:return v.createScaling(...h);case 2:return v.createRotation(f[0],O.X);case 3:return v.createRotation(f[1],O.Y);case 5:return v.createRotation(f[2],O.Z);case 4:return v.createRotation(f[2],O.Y);default:throw new Error(`Unknown transformation: ${I}`)}}).forEach(I=>{l=v.multiply(l,I)}),l}function n(a){return new Map(a.map(l=>[l.name,{diffuseColor:l.diffuseColor,specularColor:l.specularColor,specularExponent:l.specularExponent}]))}})(Gt||(Gt={}));class Wt{static POSITION_Y_CORRECTION=.31;keyframes;keyframeTime;keyframeIndex;referencePosition;transitions;active;constructor(i){this.keyframes=i,this.transitions=new Map,this.active=!1}start(){this.active=!0,this.keyframeTime=0,this.keyframeIndex=0,this.referencePosition=A.player.position,this.transitions.clear()}update(i){if(!this.active)return;if(this.keyframeTime+=i,this.keyframeTime>=this.keyframes[this.keyframeIndex].time&&(this.keyframeIndex++,this.keyframeTime=0,this.keyframeIndex>=this.keyframes.length-1)){this.active=!1;return}const e=this.keyframes[this.keyframeIndex],o=this.keyframes[this.keyframeIndex+1],r=(e.time-this.keyframeTime)/e.time;this.transitions.clear(),this.updateRootPosition(e,o,r),this.interpolate(e,o,r)}updateRootPosition(i,e,o){const r=E.interpolate(o,i.position,e.position),_=r[0]+this.referencePosition[0],c=r[2]+this.referencePosition[2],T=r[1]+A.course.findYPosition(_,c);A.player.position=[_,T,c],this.applyTransition(F.ROOT,v.createTranslation(_,T+Wt.POSITION_Y_CORRECTION,c))}interpolate(i,e,o){const r=E.interpolate(o,i.rotation,e.rotation);this.applyTransition(F.ROOT,v.createRotation(r[1],O.Y)),this.applyTransition(F.ROOT,v.createRotation(r[0],O.X)),this.applyTransition(F.ROOT,v.createRotation(r[2],O.Z));const _=w.interpolate(o,i.neckRotationZ,e.neckRotationZ);this.applyTransition(F.NECK,v.createRotation(_,O.Z));const c=w.interpolate(o,i.headRotationY,e.headRotationY);this.applyTransition(F.HEAD,v.createRotation(c,O.Y));const T=w.interpolate(o,i.leftShoulderRotationZ,e.leftShoulderRotationZ);this.applyTransition(F.LEFT_SHOULDER,v.createRotation(T,O.Z));const p=w.interpolate(o,i.rightShoulderRotationZ,e.rightShoulderRotationZ);this.applyTransition(F.RIGHT_SHOULDER,v.createRotation(p,O.Z));const d=w.interpolate(o,i.leftShoulderRotationY,e.leftShoulderRotationY);this.applyTransition(F.LEFT_SHOULDER,v.createRotation(d,O.Y));const m=w.interpolate(o,i.rightShoulderRotationY,e.rightShoulderRotationY);this.applyTransition(F.RIGHT_SHOULDER,v.createRotation(m,O.Y));const t=w.interpolate(o,i.leftHipRotationZ,e.leftHipRotationZ);this.applyTransition(F.LEFT_HIP,v.createRotation(t,O.Z));const n=w.interpolate(o,i.rightHipRotationZ,e.rightHipRotationZ);this.applyTransition(F.RIGHT_HIP,v.createRotation(n,O.Z));const a=w.interpolate(o,i.leftKneeRotationZ,e.leftKneeRotationZ);this.applyTransition(F.LEFT_KNEE,v.createRotation(a,O.Z));const l=w.interpolate(o,i.rightKneeRotationZ,e.rightKneeRotationZ);this.applyTransition(F.RIGHT_KNEE,v.createRotation(l,O.Z));const u=w.interpolate(o,i.leftAnkleRotationZ,e.leftAnkleRotationZ);this.applyTransition(F.LEFT_ANKLE,v.createRotation(u,O.Z));const h=w.interpolate(o,i.rightAnkleRotationZ,e.rightAnkleRotationZ);this.applyTransition(F.RIGHT_ANKLE,v.createRotation(h,O.Z))}applyTransition(i,e){if(!this.transitions.has(i))this.transitions.set(i,e);else{const o=this.transitions.get(i),r=v.multiply(e,o);this.transitions.set(i,r)}}}var Ct;(s=>{async function i(o,r){const T=(await(await fetch(`assets/character/${o}/animation/${r}.json`)).json()).keyframes.map(p=>e(p));return new Wt(T)}s.load=i;function e(o){return{time:o.time,position:o.position??E.ZERO,rotation:o.rotation??E.ZERO,neckRotationZ:o.neckRotationZ??0,headRotationY:o.headRotationY??0,leftShoulderRotationY:o.leftShoulderRotationY??0,leftShoulderRotationZ:o.leftShoulderRotationZ??0,rightShoulderRotationY:o.rightShoulderRotationY??0,rightShoulderRotationZ:o.rightShoulderRotationZ??0,leftHipRotationZ:o.leftHipRotationZ??0,rightHipRotationZ:o.rightHipRotationZ??0,leftKneeRotationZ:o.leftKneeRotationZ??0,rightKneeRotationZ:o.rightKneeRotationZ??0,leftAnkleRotationZ:o.leftAnkleRotationZ??0,rightAnkleRotationZ:o.rightAnkleRotationZ??0}}})(Ct||(Ct={}));class ${static MIN_TIME_STEP=.01;static MAX_TIME_STEP=.1;static MAX_TIME_STEP_DISTRIBUTION=.2;static NUM_ESTIMATES=4;static TIME_STEP_EXPONENT=1/3;static TIME_STEPS=[0,.5,.75,1];static COEFFICIENTS=[[0,.5,0,2/9],[0,0,.75,1/3],[0,0,0,4/9],[0,0,0,0]];static ERRORS=[-5/72,1/12,1/9,-1/8];k;initialValue;h;constructor(i,e){this.initialValue=i,this.h=e,this.k=new Array($.NUM_ESTIMATES).fill(0)}updateEstimate(i,e){this.k[i]=this.h*e}computeFinalEstimate(){return this.computeNextValue($.NUM_ESTIMATES-1)}estimateError(){let i=0;for(let e=0;e<$.NUM_ESTIMATES;e++)i+=$.ERRORS[e]*this.k[e];return Math.abs(i)}computeNextValue(i){let e=this.initialValue;for(let o=0;o<i;o++)e+=$.COEFFICIENTS[o][i]*this.k[o];return e}computeNextTime(i){return $.TIME_STEPS[i]*this.h}}var vt;(s=>{function i(o,r){return E.computeDotProduct(o.normal,r)+o.distance}s.computeDistanceToPlane=i;function e(o,r){return E.projectToPlane(o.normal,r)}s.projectToPlane=e})(vt||(vt={}));var ut;(s=>{s.ONE_MINUTE_IN_MILLISECONDS=60*1e3,s.ONE_SECOND_IN_MILLISECONDS=1e3,s.ONE_DECISECOND_IN_MILLISECONDS=10;function i(){return Date.now()/s.ONE_SECOND_IN_MILLISECONDS}s.getSeconds=i})(ut||(ut={}));var J=(s=>(s[s.INTRO=1]="INTRO",s[s.RACING=2]="RACING",s[s.BREAKING=3]="BREAKING",s[s.OUTRO=4]="OUTRO",s[s.TERMINATED=5]="TERMINATED",s))(J||{}),q;(s=>{s.TUX_MASS=20,s.MIN_TUX_SPEED=1.4,s.INITIAL_TUX_SPEED=3,s.BREAKING_ROLL_ANGLE=55,s.MAX_ROLL_ANGLE=30;const i=9.81,e=34600,o=122.5,r=60/3.6,_=.35,c=2.8,T=800,p=200,d=20,m=45,t=400,n=.15,a=6,l=.35,u=[0,-i*s.TUX_MASS,0],h=[0,0,-s.TUX_MASS*i/4],f=[-1,0,1,2,3,4,5,6],I=[2.25,1.35,.6,0,-.35,-.45,-.33,-.9];function g(L,P){const C=E.computeLength(P),[D,b]=A.course.findFrictionAndDepth(L[0],L[2]),k=A.course.findPlane(L[0],L[2]),G=vt.computeDistanceToPlane(k,L),X=G>0,z=M(C,k,P,D),Q=E.negate(E.normalize(P)),nt=N(G,b,P,z),ot=V(D,Q,C,nt,k,X),rt=R(P),at=S(C,D,Q,X),st=x(C,X,D,Q);return E.addAll(u,nt,ot,rt,at,st)}s.computeForce=g;function R(L){const P=E.negate(L),C=E.computeLength(P),D=e*C,b=w.interpolateLinear(f,I,Math.log10(D)),G=.104*Math.pow(10,b)*C;return E.multiply(G,P)}function x(L,P,C,D){if(A.control.isPaddling&&A.player.orientation){let b;if(P)b=E.rotateVector(A.player.orientation,h);else{const k=-Math.min(o,o*(r-L)/r*Math.min(1,C/_));b=E.multiply(k,D)}return b}return E.ZERO}function S(L,P,C,D){if(A.state!==J.BREAKING){if(A.control.isBraking&&!D&&L>c&&L>s.MIN_TUX_SPEED)return E.multiply(p+P,C)}else{const b=D?d:A.courseConfig.finishBrake;return E.multiply(A.player.finishSpeed*b,C)}return E.ZERO}function N(L,P,C,D){if(L>-P)return E.ZERO;const b=E.computeDotProduct(C,D),k=-L-P;let G=Math.min(k,.05)*1500;return G+=w.clamp(0,k-.05,.12)*3e3,G+=Math.max(0,k-.12-.05)*1e4,G-=b*(k<=.05?1500:500),G=w.clamp(0,G,3e3),E.multiply(G,D)}function V(L,P,C,D,b,k){if(!k&&C>c||A.state===J.BREAKING){const G=Math.min(E.computeLength(D)*L,T);let X=E.multiply(G,P),z=A.control.turnFactor*m;Math.abs(G*Math.sin(w.toRadians(z)))>t&&(z=w.toDegrees(Math.asin(t/G))*A.control.turnFactor/Math.abs(A.control.turnFactor));const Q=v.createRotationAroundVector(z,b.normal);return X=E.transformVector(Q,X),E.multiply(1+n,X)}return E.ZERO}function M(L,P,C,D){const b=E.normalize(vt.projectToPlane(P,C)),k=A.control.isBraking?s.BREAKING_ROLL_ANGLE:s.MAX_ROLL_ANGLE,G=A.control.turnFactor*k*Math.min(1,Math.max(0,D)/l)*Math.min(1,Math.max(0,L-s.MIN_TUX_SPEED)/(a-s.MIN_TUX_SPEED)),X=v.createRotationAroundVector(G,b);return E.transformVector(X,P.normal)}})(q||(q={}));class W{static MAX_POSITION_ERROR=.005;static MAX_VELOCITY_ERROR=.05;static MIN_TIME_STEP=.01;static MAX_SURFACE_PENETRATION=.2;static TUX_Y_CORRECTION=.36;static MAX_ARM_ANGLE=30;static MAX_PADDLING_ANGLE=35;static MAX_EXT_PADDLING_ANGLE=30;static MAX_KICK_PADDLING_ANGLE=20;static PADDLING_DURATION=.4;static ROLL_DECAY=.2;force;odeTimeStep;turnAnimationState;lastCollisionItem;transitions;velocity;speed;finishSpeed;position;lastPosition;direction;isAirborne;orientation;constructor(){this.transitions=new Map,this.turnAnimationState=0,this.force=E.ZERO,this.odeTimeStep=-1,this.isAirborne=!1}init(){this.position=[A.courseConfig.startX,A.course.findYPosition(A.courseConfig.startX,A.courseConfig.startY),A.courseConfig.startY],this.velocity=this.computeInitialVelocity(),this.speed=E.computeLength(this.velocity),this.direction=this.velocity}update(i){this.transitions.clear(),i>2*Number.EPSILON&&this.solveOdeSystem(i);const e=A.course.findPlane(this.position[0],this.position[2]),o=vt.computeDistanceToPlane(e,this.position);this.isAirborne=o>0,this.speed<q.MIN_TUX_SPEED&&(this.velocity=E.multiply(q.MIN_TUX_SPEED,E.normalize(this.velocity))),this.adjustPosition(e,o),this.adjustOrientation(i,e,o),this.adjustJoints(i)}saveFinishSpeed(){this.finishSpeed=this.speed}adjustJoints(i){const e=E.rotateVector(ct.conjugate(this.orientation),this.force);A.control.turnFactor===0?this.turnAnimationState*=Math.max(0,1-i/W.ROLL_DECAY):(this.turnAnimationState+=A.control.turnFactor*2*i,this.turnAnimationState=w.clamp(-1,this.turnAnimationState,1));let o=0,r=0;if(A.control.isPaddling){const R=(ut.getSeconds()-A.control.paddleStartTime)/W.PADDLING_DURATION;this.isAirborne?(r=0,o=R):(r=R,o=0)}const _=A.control.isBraking?W.MAX_ARM_ANGLE:0,c=W.MAX_PADDLING_ANGLE*Math.sin(r*Math.PI),T=W.MAX_EXT_PADDLING_ANGLE*Math.sin(r*Math.PI),p=W.MAX_KICK_PADDLING_ANGLE*Math.sin(r*w.PI_2),d=Math.max(-this.turnAnimationState,0)*W.MAX_ARM_ANGLE,m=Math.max(this.turnAnimationState,0)*W.MAX_ARM_ANGLE,t=W.MAX_ARM_ANGLE*(.5+.5*Math.sin(Math.PI*o*6-w.PI_0_5)),n=w.clamp(-20,-e[2]/300,20),a=this.turnAnimationState*10,l=v.createRotation(Math.min(_+c+d,W.MAX_ARM_ANGLE)+t,O.Z),u=v.createRotation(-T,O.Y);this.transitions.set(F.LEFT_SHOULDER,v.multiply(l,u));const h=v.createRotation(Math.min(_+c+m,W.MAX_ARM_ANGLE)+t,O.Z),f=v.createRotation(T,O.Y);this.transitions.set(F.RIGHT_SHOULDER,v.multiply(h,f)),this.transitions.set(F.LEFT_HIP,v.createRotation(-20+a+n,O.Z)),this.transitions.set(F.RIGHT_HIP,v.createRotation(-20-a+n,O.Z)),this.transitions.set(F.LEFT_KNEE,v.createRotation(-10+a-Math.min(35,this.speed)+p+n,O.Z)),this.transitions.set(F.RIGHT_KNEE,v.createRotation(-10-a-Math.min(35,this.speed)-p+n,O.Z)),this.transitions.set(F.LEFT_ANKLE,v.createRotation(-20+Math.min(50,this.speed),O.Z)),this.transitions.set(F.RIGHT_ANKLE,v.createRotation(-20+Math.min(50,this.speed),O.Z)),this.transitions.set(F.TAIL,v.createRotation(this.turnAnimationState*20,O.Z)),this.transitions.set(F.NECK,v.createRotation(-50,O.Z));const I=v.createRotation(-30,O.Z),g=v.createRotation(-this.turnAnimationState*70,O.Y);this.transitions.set(F.HEAD,v.multiply(I,g))}adjustPosition(i,e){if(e<-.2){const r=-.2-e;this.position=E.add(this.position,E.multiply(r,i.normal))}const o=(A.courseConfig.width-A.courseConfig.playWidth)/2;this.position[0]<o&&(this.position[0]=o),this.position[0]>A.courseConfig.width-o&&(this.position[0]=A.courseConfig.width-o),this.position[2]>0&&(this.position[2]=0),this.transitions.set(F.ROOT,v.createTranslation(this.position[0],this.position[1]+W.TUX_Y_CORRECTION,this.position[2]))}adjustOrientation(i,e,o){let r,_;o>0?(r=E.normalize(this.velocity),_=E.normalize(E.projectToPlane(r,E.NEGATIVE_Y_UNIT)),_=this.adjustRollVector(_)):(_=E.negate(e.normal),_=this.adjustRollVector(_),r=E.normalize(vt.projectToPlane(e,this.velocity)));const c=E.computeCrossProduct(r,_),T=v.createFromVectors(c,r,_),p=ct.createFromRotationMatrix(T);this.orientation||(this.orientation=p);const d=o>0?.5:.14;this.orientation=ct.interpolate(this.orientation,p,Math.min(i/d,1)),this.direction=E.rotateVector(this.orientation,E.Z_UNIT);const m=this.transitions.get(F.ROOT);this.transitions.set(F.ROOT,v.multiply(v.createFromQuaternion(this.orientation),m))}adjustRollVector(i){const e=E.normalize(E.projectToPlane(i,this.velocity));let o;return A.control.isBraking?o=v.createRotationAroundVector(A.control.turnFactor*q.BREAKING_ROLL_ANGLE,e):o=v.createRotationAroundVector(A.control.turnFactor*q.MAX_ROLL_ANGLE,e),E.transformVector(o,i)}solveOdeSystem(i){let e,o,r=this.odeTimeStep;r<0&&(r=this.adjustTimeStep(r,this.velocity));let _=0,c,T,p,d,m,t,n=this.position,a=this.velocity,l=this.force,u=!1;for(;!u;){if(_>=i)throw new Error("t >= timeStep in ODE solver");1.1*r>i-_&&(r=i-_,u=!0);const h=n,f=a,I=l;let g=!1;for(;;){c=new $(n[0],r),T=new $(n[1],r),p=new $(n[2],r),d=new $(a[0],r),m=new $(a[1],r),t=new $(a[2],r),c.updateEstimate(0,a[0]),T.updateEstimate(0,a[1]),p.updateEstimate(0,a[2]),d.updateEstimate(0,l[0]/q.TUX_MASS),m.updateEstimate(0,l[1]/q.TUX_MASS),t.updateEstimate(0,l[2]/q.TUX_MASS);for(let S=1;S<$.NUM_ESTIMATES;S++)n=[c.computeNextValue(S),T.computeNextValue(S),p.computeNextValue(S)],a=[d.computeNextValue(S),m.computeNextValue(S),t.computeNextValue(S)],l=q.computeForce(n,a),c.updateEstimate(S,a[0]),T.updateEstimate(S,a[1]),p.updateEstimate(S,a[2]),d.updateEstimate(S,l[0]/q.TUX_MASS),m.updateEstimate(S,l[1]/q.TUX_MASS),t.updateEstimate(S,l[2]/q.TUX_MASS);n=[c.computeFinalEstimate(),T.computeFinalEstimate(),p.computeFinalEstimate()],a=[d.computeFinalEstimate(),m.computeFinalEstimate(),t.computeFinalEstimate()];const R=this.computeSolverError(c,T,p),x=this.computeSolverError(d,m,t);if(R/W.MAX_POSITION_ERROR>x/W.MAX_VELOCITY_ERROR?(e=R,o=W.MAX_POSITION_ERROR):(e=x,o=W.MAX_VELOCITY_ERROR),e>o&&r>W.MIN_TIME_STEP+Number.EPSILON)u=!1,g?r*=.5:(g=!0,r*=Math.max(.5,.8*Math.pow(o/e,$.TIME_STEP_EXPONENT))),r=this.adjustTimeStep(r,f),n=h,a=f,l=I;else break}if(_+=r,l=q.computeForce(n,a),!g){const R=1.25*Math.pow(e/o,$.TIME_STEP_EXPONENT);R>.2?r/=R:r*=5}r=this.adjustTimeStep(r,a),a=this.computeVelocityOnItemCollision(n,a)}this.odeTimeStep=r,this.force=l,this.velocity=a,this.speed=E.computeLength(this.velocity),this.lastPosition=this.position,this.position=n}computeVelocityOnItemCollision(i,e){const o=A.items.findCollidingItem(i,this.position);if(!o)return delete this.lastCollisionItem,e;if(this.lastCollisionItem===o)return e;this.lastCollisionItem=o,A.soundPlayer.playSound(it.TREE_HIT);let r=E.subtract(i,o.position);r[1]=0,r=E.normalize(r);let _=E.normalize(e);const c=E.computeDotProduct(_,r);if(c<0){const p=this.isAirborne?.5:1.5;_=E.normalize(E.add(_,E.multiply(-p*c,r)))}const T=Math.max(E.computeLength(e)*.8,q.MIN_TUX_SPEED);return E.multiply(T,_)}computeSolverError(i,e,o){return E.computeLength([i.estimateError(),e.estimateError(),o.estimateError()])}adjustTimeStep(i,e){const o=E.computeLength(e);return i=w.clamp($.MIN_TIME_STEP,i,$.MAX_TIME_STEP_DISTRIBUTION/o),Math.min(i,$.MAX_TIME_STEP)}computeInitialVelocity(){const i=A.course.findNormal(A.courseConfig.startX,A.courseConfig.startY),e=v.createRotation(-90,O.X);return E.multiply(q.INITIAL_TUX_SPEED,E.transformVector(e,i))}}class $t{static PADDLING_DURATION=.4;turnFactor;isBraking;isPaddling;paddleStartTime;constructor(){this.turnFactor=0,this.isBraking=!1,this.isPaddling=!1,this.paddleStartTime=0}update(i,e){this.turnFactor=0;let o,r;if(A.state===J.BREAKING)o=!0,r=!1;else if(e.stickAngle)this.turnFactor=Math.sin(e.stickAngle),o=e.isPointingBackward,r=e.isPointingForward;else{const _=i.keyboardA||i.keyboardArrowLeft,c=i.keyboardD||i.keyboardArrowRight;_!==c&&(this.turnFactor=c?1:-1),o=i.keyboardS||i.keyboardArrowDown,r=i.keyboardW||i.keyboardArrowUp}r!==o?(this.isBraking=o,r&&!this.isPaddling&&(this.isPaddling=!0,this.paddleStartTime=ut.getSeconds())):this.isBraking=!1,this.isPaddling&&!r&&ut.getSeconds()-this.paddleStartTime>$t.PADDLING_DURATION&&(this.isPaddling=!1)}}var pt;(s=>{s.NEAR_CLIPPING_DISTANCE=.1,s.FAR_CLIPPING_DISTANCE=75,s.BACKWARD_CLIPPING_DISTANCE=20,s.FAR_CLIPPING_FUDGE_AMOUNT=5,s.FIELD_OF_VIEW=60})(pt||(pt={}));class xt{static VERTEX_SHADER=`#version 300 es

#define NORMAL vec3(0.0, 0.0, 1.0)
#define SPECULAR_EXPONENT 1.0

in vec4 a_Position;
in vec2 a_TextureCoordinate;

uniform mat4 u_ModelViewMatrix;
uniform mat4 u_ViewMatrix;
uniform mat4 u_ProjectionMatrix;
uniform mat4 u_NormalMatrix;

$$lighting-function$$

out vec3 v_LightColor;
out float v_FogFactor;
out vec2 v_TextureCoordinate;

void main() {
  vec4 eyePosition = u_ModelViewMatrix * a_Position;
  gl_Position = u_ProjectionMatrix * eyePosition;
  
  v_LightColor = computeAllLights(eyePosition);
  v_FogFactor = computeFogFactor(eyePosition);
  
  v_TextureCoordinate = a_TextureCoordinate;
}
`;static FRAGMENT_SHADER=`#version 300 es
precision mediump float;

in vec3 v_LightColor;
in float v_FogFactor;
in vec2 v_TextureCoordinate;

uniform sampler2D u_texture;

out vec4 outColor;

$$lighting-function$$

void main() {
  vec4 textureColor = texture(u_texture, v_TextureCoordinate);
  if (textureColor.a < 0.5) {
    discard;
  }
  
  outColor = computeFinalColor(textureColor);
}
`;static SHADER_LIGHT_SETTINGS={useMaterial:!1,useStaticNormal:!0,useNormalMatrix:!0};dynamicItems;shader;textures;viewMatrixUniformLocation;modelViewMatrixUniformLocation;projectionMatrixUniformLocation;normalMatrixUniformLocation;vertexArray;async init(i,e){this.textures=i,this.dynamicItems=e;const o=y.gl;this.shader=_t.createShader(xt.VERTEX_SHADER,xt.FRAGMENT_SHADER,xt.SHADER_LIGHT_SETTINGS,o),[this.viewMatrixUniformLocation,this.modelViewMatrixUniformLocation,this.projectionMatrixUniformLocation,this.normalMatrixUniformLocation]=Z.getUniformLocations(this.shader,o,"u_ViewMatrix","u_ModelViewMatrix","u_ProjectionMatrix","u_NormalMatrix");const[r,_]=Z.getAttributeLocations(this.shader,o,"a_Position","a_TextureCoordinate");this.vertexArray=U.createAndBindVertexArray(o),U.bindPositions(tt.FLAT_POSITIONS,r,o),U.bindIndices(tt.FLAT_INDICES,o),U.bindTextureCoordinates(tt.FLAT_TEXTURE_COORDINATES,_,o)}draw(i){i.useProgram(this.shader),i.uniformMatrix4fv(this.viewMatrixUniformLocation,!1,y.viewMatrix),i.uniformMatrix4fv(this.projectionMatrixUniformLocation,!1,y.perspectiveMatrix),this.dynamicItems.forEach((e,o)=>{this.drawItemsOfType(o,e,i)})}drawItemsOfType(i,e,o){const r=this.textures[i.glId];o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,r),o.bindVertexArray(this.vertexArray),e.forEach(_=>this.drawItem(_,o))}drawItem(i,e){if(i.isCollected||!this.isInClipDistance(i))return;y.modelViewMatrix.push(),y.modelViewMatrix.multiply(v.createTranslation(...i.position));const o=E.subtract(y.cameraPosition,i.position),r=w.toDegrees(Math.atan2(o[0],o[2]));y.modelViewMatrix.multiply(v.createRotation(r,O.Y)),y.modelViewMatrix.multiply(v.createScaling(i.diameter,i.height,i.diameter)),e.uniformMatrix4fv(this.modelViewMatrixUniformLocation,!1,y.modelViewMatrix.current),e.uniformMatrix4fv(this.normalMatrixUniformLocation,!0,v.invert(y.modelViewMatrix.current)??y.modelViewMatrix.current),e.drawElements(e.TRIANGLES,tt.FLAT_INDICES.length,e.UNSIGNED_SHORT,0),y.modelViewMatrix.pop()}isInClipDistance(i){const e=y.cameraPosition[2],o=i.position[2];return e-o>pt.FAR_CLIPPING_DISTANCE?!1:o-e<=pt.BACKWARD_CLIPPING_DISTANCE}}class ft{static COS_1=Math.cos(w.toRadians(1));static SIN_1=Math.sin(w.toRadians(1));static VERTEX_SHADER=`#version 300 es

#define NORMAL vec3(0.0, 0.0, 1.0)
#define SPECULAR_EXPONENT 1.0

in vec4 a_Position;
in vec2 a_TextureCoordinate;
in float a_TextureIndex;

uniform mat4 u_ModelViewMatrix;
uniform mat4 u_ViewMatrix;
uniform mat4 u_ProjectionMatrix;

out vec3 v_LightColor;
out float v_FogFactor;
out vec2 v_TextureCoordinate;
flat out uint v_TextureIndex;

$$lighting-function$$

void main() {
  vec4 eyePosition = u_ModelViewMatrix * a_Position;
  gl_Position = u_ProjectionMatrix * eyePosition;
  
  v_LightColor = computeAllLights(eyePosition);
  v_FogFactor = computeFogFactor(eyePosition);
  
  v_TextureCoordinate = a_TextureCoordinate;
  v_TextureIndex = uint(a_TextureIndex);
}
`;static FRAGMENT_SHADER=`#version 300 es
#define NUM_TEXTURES 7
  
precision mediump float;

in vec3 v_LightColor;
in float v_FogFactor;
in vec2 v_TextureCoordinate;
flat in uint v_TextureIndex;

uniform sampler2D u_Textures[NUM_TEXTURES];

out vec4 outColor;

$$lighting-function$$
 
vec4 getTextureColor() {
  switch (v_TextureIndex) {
    case 0u:
      return texture(u_Textures[0], v_TextureCoordinate);
    case 1u:
      return texture(u_Textures[1], v_TextureCoordinate);
    case 2u:
      return texture(u_Textures[2], v_TextureCoordinate);
    case 3u:
      return texture(u_Textures[3], v_TextureCoordinate);
    case 4u:
      return texture(u_Textures[4], v_TextureCoordinate);
    case 5u:
      return texture(u_Textures[5], v_TextureCoordinate);
    case 6u:
      return texture(u_Textures[6], v_TextureCoordinate);
    default:
      return vec4(0.0);
  }
}
 
void main() {
  vec4 textureColor = getTextureColor();
  if (textureColor.a < 0.5) {
    discard;
  }
  
  outColor = computeFinalColor(textureColor);
}
`;static SHADER_LIGHT_SETTINGS={useMaterial:!1,useStaticNormal:!0,useNormalMatrix:!1};shader;textures;textureMapping;viewMatrixUniformLocation;modelViewMatrixUniformLocation;projectionMatrixUniformLocation;texturesUniformLocation;vertexArray;numIndices;async init(i,e){this.textures=i,this.textureMapping=[...this.textures.keys()];const o=y.gl;this.shader=_t.createShader(ft.VERTEX_SHADER,ft.FRAGMENT_SHADER,ft.SHADER_LIGHT_SETTINGS,o),[this.viewMatrixUniformLocation,this.modelViewMatrixUniformLocation,this.projectionMatrixUniformLocation,this.texturesUniformLocation]=Z.getUniformLocations(this.shader,o,"u_ViewMatrix","u_ModelViewMatrix","u_ProjectionMatrix","u_Textures");const[r,_,c]=Z.getAttributeLocations(this.shader,o,"a_Position","a_TextureCoordinate","a_TextureIndex");[this.vertexArray,this.numIndices]=this.createStaticVertexArray(e,r,_,c,o)}draw(i){i.useProgram(this.shader),i.uniformMatrix4fv(this.projectionMatrixUniformLocation,!1,y.perspectiveMatrix),i.uniformMatrix4fv(this.viewMatrixUniformLocation,!1,y.viewMatrix),i.uniformMatrix4fv(this.modelViewMatrixUniformLocation,!1,y.modelViewMatrix.current),i.uniform1iv(this.texturesUniformLocation,this.textureMapping),mt.bindTextures(this.textures,i),i.bindVertexArray(this.vertexArray),i.drawElements(i.TRIANGLES,this.numIndices,i.UNSIGNED_SHORT,0)}createStaticVertexArray(i,e,o,r,_){const c=[],T=[],p=[],d=[];i.forEach(t=>{const n=t.type.glId;t.type.isFlat?(T.push(...this.offsetIndices(tt.FLAT_INDICES,c.length/3)),c.push(...this.transformPositions(tt.FLAT_POSITIONS,t)),p.push(...tt.FLAT_TEXTURE_COORDINATES),d.push(n,n,n,n)):(T.push(...this.offsetIndices(tt.TREE_INDICES,c.length/3)),c.push(...this.transformPositions(tt.TREE_POSITIONS,t)),p.push(...tt.TREE_TEXTURE_COORDINATES),d.push(n,n,n,n,n,n,n,n))});const m=U.createAndBindVertexArray(_);return U.bindPositions(c,e,_),U.bindIndices(T,_),U.bindTextureCoordinates(p,o,_),U.bindTextureIndices(d,r,_),[m,T.length]}offsetIndices(i,e){return i.map(o=>o+e)}transformPositions(i,e){const o=[];for(let r=0;r<i.length;r+=3){const _=i[r]*ft.COS_1+i[r+2]*ft.SIN_1,c=i[r+1],T=-i[r]*ft.SIN_1+i[r+2]*ft.COS_1;o.push(_*e.diameter+e.position[0]),o.push(c*e.height+e.position[1]),o.push(T*e.diameter+e.position[2])}return o}}class tt{static FLAT_POSITIONS=[-.5,1,0,.5,1,0,-.5,0,0,.5,0,0];static FLAT_TEXTURE_COORDINATES=[0,0,1,0,0,1,1,1];static FLAT_INDICES=[0,1,2,1,3,2];static TREE_POSITIONS=[...tt.FLAT_POSITIONS,0,1,-.5,0,1,.5,0,0,-.5,0,0,.5];static TREE_TEXTURE_COORDINATES=[...tt.FLAT_TEXTURE_COORDINATES,...tt.FLAT_TEXTURE_COORDINATES];static TREE_INDICES=[...tt.FLAT_INDICES,4,5,6,5,6,7];dynamicRenderer;staticRenderer;constructor(){this.dynamicRenderer=new xt,this.staticRenderer=new ft}async init(i){const e=await this.loadItemTextures(i,y.gl),o=this.filterDynamicItems(i);await this.dynamicRenderer.init(e,o);const r=this.filterStaticItems(i);await this.staticRenderer.init(e,r)}draw(){const i=y.gl;i.disable(i.CULL_FACE),i.enable(i.DEPTH_TEST),i.depthFunc(i.LESS),i.depthMask(!0),i.enable(i.BLEND),i.blendFuncSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE),this.staticRenderer.draw(i),this.dynamicRenderer.draw(i)}filterDynamicItems(i){const e=new Map;return i.forEach((o,r)=>{(!r.isStatic||r.isCollectable)&&e.set(r,o)}),e}filterStaticItems(i){const e=[];return i.forEach((o,r)=>{r.isStatic&&!r.isCollectable&&e.push(...o)}),e}async loadItemTextures(i,e){const o=[];for(const r of i.keys())o[r.glId]=mt.loadFromFile(`assets/items/${r.texture}`,!1,e);return await Promise.all(o)}}class gt{static LARGEST_ITEM_RADIUS=.75;items;itemsWithCollision;itemsToCollect;renderer;constructor(i){this.items=i,this.itemsWithCollision=[],i.forEach((e,o)=>{o.hasCollision&&this.itemsWithCollision.push(...e)}),this.itemsToCollect=[],i.forEach((e,o)=>{o.isCollectable&&this.itemsToCollect.push(...e)}),this.renderer=new tt}async init(){await this.renderer.init(this.items)}draw(){this.renderer.draw()}handleItemCollection(){let i=0;const e=this.createBoundingRectangle(A.player.position,A.player.lastPosition);for(const o of this.itemsToCollect)!o.isCollected&&this.isInBoundingRectangle(o,e)&&o.hasCollisionDuringMovement(o,A.player.position,A.player.lastPosition)&&(o.isCollected=!0,i++);return i>0&&(A.soundPlayer.playSound(it.PICKUP_1),A.soundPlayer.playSound(it.PICKUP_2),A.soundPlayer.playSound(it.PICKUP_3)),i}findCollidingItem(i,e){const o=this.createBoundingRectangle(i,e);for(const r of this.itemsWithCollision)if(this.isInBoundingRectangle(r,o)&&r.hasCollisionDuringMovement(r,i,e))return r}createBoundingRectangle(i,e){return{xMin:Math.min(i[0],e[0])-gt.LARGEST_ITEM_RADIUS,xMax:Math.max(i[0],e[0])+gt.LARGEST_ITEM_RADIUS,zMin:Math.min(i[2],e[2])-gt.LARGEST_ITEM_RADIUS,zMax:Math.max(i[2],e[2])+gt.LARGEST_ITEM_RADIUS}}isInBoundingRectangle(i,e){return e.xMin<=i.position[0]&&e.xMax>=i.position[0]&&e.zMin<=i.position[2]&&e.zMax>=i.position[2]}}class ie{collisionDiameter;collisionRadius;type;position;height;diameter;isCollected;constructor(i,e,o,r){this.type=i,this.position=e,this.height=o,this.diameter=r,this.isCollected=!1,this.collisionDiameter=this.diameter*this.type.collisionDiameter,this.collisionRadius=this.collisionDiameter/2}hasCollisionDuringMovement(i,e,o){if(this.hasCollision(i,e))return!0;const r=E.subtract(e,o),_=E.computeLength(r),c=Math.floor(_/this.collisionDiameter);if(c===0)return!1;const T=E.multiply(1/(c+1),r);let p=o;for(let d=0;d<c;d++)if(p=E.add(p,T),this.hasCollision(i,p))return!0;return!1}hasCollision(i,e){return e[2]-this.collisionRadius<i.position[2]&&e[2]+this.collisionRadius>i.position[2]&&e[0]-this.collisionRadius<i.position[0]&&e[0]+this.collisionRadius>i.position[0]&&e[1]<i.position[1]+i.height}}var bt;(s=>{s.INDEX=new Map([["SHRUB",{texture:"shrub.webp",glId:0,collisionDiameter:.6,hasCollision:!0,isFlat:!1,isCollectable:!1,isStatic:!0}],["TREE",{texture:"snowy_tree1.webp",glId:1,collisionDiameter:.4,hasCollision:!0,isFlat:!1,isCollectable:!1,isStatic:!0}],["FLAG",{texture:"flag.webp",glId:2,collisionDiameter:0,hasCollision:!1,isFlat:!0,isCollectable:!1,isStatic:!1}],["HERRING",{texture:"herring.webp",glId:3,collisionDiameter:1.5,hasCollision:!1,isFlat:!0,isCollectable:!0,isStatic:!1}],["TREE_BARREN",{texture:"tree_barren2.webp",glId:4,collisionDiameter:.4,hasCollision:!0,isFlat:!1,isCollectable:!1,isStatic:!0}],["START",{texture:"start.webp",glId:5,collisionDiameter:0,hasCollision:!1,isFlat:!0,isCollectable:!1,isStatic:!0}],["FINISH",{texture:"finish.webp",glId:6,collisionDiameter:0,hasCollision:!1,isFlat:!0,isCollectable:!1,isStatic:!0}]])})(bt||(bt={}));var Vt;(s=>{async function i(){const p=(await(await fetch(`assets/course/${A.courseConfig.key}/items.json`)).json()).items.map(d=>o(d));return new gt(e(p))}s.load=i;function e(c){const T=new Map;for(const p of bt.INDEX.values()){const d=c.filter(m=>m.type===p);d.length>0&&T.set(p,d)}return T}function o(c){const T=_(c.type),p=r(c);return new ie(T,p,c.height,c.diameter)}function r(c){const T=(A.course.numFieldsX-c.x)/(A.course.numFieldsX-1)*A.courseConfig.width,p=-((A.course.numFieldsY-c.z)/(A.course.numFieldsY-1))*A.courseConfig.length,d=A.course.findYPosition(T,p);return[T,d,p]}function _(c){const T=bt.INDEX.get(c);if(!T)throw new Error("Unknown item type: "+c);return T}})(Vt||(Vt={}));class j{static VERTEX_SHADER=`#version 300 es

#define SPECULAR_EXPONENT 1.0

in vec4 a_Position;
in vec3 a_Normal;
in vec2 a_TextureCoordinate;

uniform mat4 u_ModelViewMatrix;
uniform mat4 u_ViewMatrix;
uniform mat4 u_ProjectionMatrix;

out vec2 v_TextureCoordinate;
out vec3 v_LightColor;

$$lighting-function$$

void main() {
  vec4 eyePosition = u_ViewMatrix * a_Position;
  gl_Position = u_ProjectionMatrix * eyePosition;
  
  v_TextureCoordinate = a_TextureCoordinate;
  
  v_LightColor = computeAllLights(eyePosition);
}
`;static FRAGMENT_SHADER=`#version 300 es
#define TRACKS_ALPHA 0.75
  
precision mediump float;

in vec2 v_TextureCoordinate;
in vec3 v_LightColor;

uniform sampler2D u_texture;

out vec4 outColor;
 
void main() {
  vec4 textureColor = texture(u_texture, v_TextureCoordinate);
  if (textureColor.a < 0.5) {
    discard;
  }
  
  outColor = vec4(textureColor.rgb * v_LightColor, TRACKS_ALPHA);
}
`;static SHADER_LIGHT_SETTINGS={useMaterial:!1,useStaticNormal:!1,useNormalMatrix:!1};static MIN_TRACK_DISTANCE=.5;static MAX_NUM_TRACK_MARKS=30;static HALF_TRACK_WIDTH=.35;static TRACK_Y_OFFSET=.08;static START_TEXTURE_COORDINATES=[[0,0],[.333,0],[0,1],[.333,1]];static TRACK_TEXTURE_COORDINATES=[[.333,0],[.666,0],[.333,1],[.666,1]];static END_TEXTURE_COORDINATES=[[.666,0],[1,0],[.666,1],[1,1]];static INDICES=[0,1,2,1,2,3];viewMatrixUniformLocation;modelViewMatrixUniformLocation;projectionMatrixUniformLocation;shader;texture;vertexArray;dynamicBuffer;numTrackMarks;nextTrackMarkIndex;lastTrackMark;constructor(){this.numTrackMarks=0,this.nextTrackMarkIndex=0}async init(){const i=y.gl;this.shader=_t.createShader(j.VERTEX_SHADER,j.FRAGMENT_SHADER,j.SHADER_LIGHT_SETTINGS,i),[this.viewMatrixUniformLocation,this.modelViewMatrixUniformLocation,this.projectionMatrixUniformLocation]=Z.getUniformLocations(this.shader,i,"u_ViewMatrix","u_ModelViewMatrix","u_ProjectionMatrix");const[e,o,r]=Z.getAttributeLocations(this.shader,i,"a_Position","a_Normal","a_TextureCoordinate");this.vertexArray=U.createAndBindVertexArray(i),this.dynamicBuffer=U.createAndBindBuffer(i),i.bufferData(i.ARRAY_BUFFER,j.MAX_NUM_TRACK_MARKS*8*4*4,i.DYNAMIC_DRAW),i.enableVertexAttribArray(e),i.vertexAttribPointer(e,3,i.FLOAT,!1,8*4,0),i.enableVertexAttribArray(o),i.vertexAttribPointer(o,3,i.FLOAT,!1,8*4,3*4),i.enableVertexAttribArray(r),i.vertexAttribPointer(r,2,i.FLOAT,!1,8*4,6*4),U.bindIndices(this.createIndices(),i),this.texture=await mt.loadFromFile("assets/track-marks.webp",!1,i)}update(){if(!this.lastTrackMark){if(!this.isTrackMarkNeeded())return;const[p,d,m,t]=this.computeWingPositions();this.lastTrackMark={leftWingPosition:p,leftWingNormal:d,rightWingPosition:m,rightWingNormal:t,playerPosition:A.player.position,isStart:!0};return}if(E.computeLength(E.subtract(A.player.position,this.lastTrackMark.playerPosition))<j.MIN_TRACK_DISTANCE)return;const e=!this.isTrackMarkNeeded(),[o,r,_,c]=this.computeWingPositions(),T=this.lastTrackMark.isStart?j.START_TEXTURE_COORDINATES:e?j.END_TEXTURE_COORDINATES:j.TRACK_TEXTURE_COORDINATES;this.updateDynamicBuffer(o,r,_,c,this.lastTrackMark.leftWingPosition,this.lastTrackMark.leftWingNormal,this.lastTrackMark.rightWingPosition,this.lastTrackMark.rightWingNormal,T),e?delete this.lastTrackMark:this.lastTrackMark={leftWingPosition:o,leftWingNormal:r,rightWingPosition:_,rightWingNormal:c,playerPosition:A.player.position,isStart:!1}}isTrackMarkNeeded(){return A.player.isAirborne?!1:A.course.canHaveTrackMarks(A.player.position[0],A.player.position[2])}computeWingPositions(){const i=E.multiply(j.HALF_TRACK_WIDTH,E.normalize(E.computeCrossProduct(A.player.direction,E.Y_UNIT))),e=E.subtract(A.player.position,i);e[1]=A.course.findYPosition(e[0],e[2])+j.TRACK_Y_OFFSET;const o=A.course.findNormal(e[0],e[2]),r=E.add(A.player.position,i);r[1]=A.course.findYPosition(r[0],r[2])+j.TRACK_Y_OFFSET;const _=A.course.findNormal(r[0],r[2]);return[e,o,r,_]}updateDynamicBuffer(i,e,o,r,_,c,T,p,d){const m=[...i,...e,...d[0],...o,...r,...d[1],..._,...c,...d[2],...T,...p,...d[3]],t=y.gl;t.bindBuffer(t.ARRAY_BUFFER,this.dynamicBuffer),t.bufferSubData(t.ARRAY_BUFFER,this.nextTrackMarkIndex*8*4*4,new Float32Array(m)),this.nextTrackMarkIndex=(this.nextTrackMarkIndex+1)%j.MAX_NUM_TRACK_MARKS,this.numTrackMarks=Math.min(this.numTrackMarks+1,j.MAX_NUM_TRACK_MARKS)}draw(){if(this.numTrackMarks===0)return;const i=y.gl;i.disable(i.CULL_FACE),i.enable(i.DEPTH_TEST),i.depthFunc(i.LEQUAL),i.depthMask(!1),i.enable(i.BLEND),i.blendFuncSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE),i.useProgram(this.shader),i.uniformMatrix4fv(this.projectionMatrixUniformLocation,!1,y.perspectiveMatrix),i.uniformMatrix4fv(this.viewMatrixUniformLocation,!1,y.viewMatrix),i.uniformMatrix4fv(this.modelViewMatrixUniformLocation,!1,y.modelViewMatrix.current),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.texture),i.bindVertexArray(this.vertexArray),i.drawElements(i.TRIANGLES,this.numTrackMarks*6,i.UNSIGNED_SHORT,0)}createIndices(){const i=[];for(let e=0;e<j.MAX_NUM_TRACK_MARKS;e++){const o=e*4;i.push(...j.INDICES.map(r=>r+o))}return i}}class At{static VERTEX_SHADER=`#version 300 es
in vec4 a_Position;

uniform mat4 u_TransformationMatrix;

out float y;

void main() {
  gl_Position = u_TransformationMatrix * a_Position;
  y = a_Position.y;
}
`;static FRAGMENT_SHADER=`#version 300 es
#define FOG_COLOR $$fog-color$$
#define FOG_HEIGHT $$fog-height$$
#define FOG_FADE_HEIGHT 0.2
  
precision mediump float;

in float y;

out vec4 outColor;
 
void main() {
  if (y > -FOG_HEIGHT) {
    discard;
  } else if (y > -(FOG_HEIGHT + FOG_FADE_HEIGHT)) {
    float alpha = (-FOG_HEIGHT - y) / FOG_FADE_HEIGHT;
    outColor = vec4(FOG_COLOR.rgb, alpha);
  } else {
    outColor = FOG_COLOR;
  }
}
`;static POSITIONS=[-1,-1,-1,1,-1,-1,1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,1,1,1,-1,-1,-1,1,1,-1,1,1,-1,-1,-1,-1,-1];static INDICES=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19];shader;vertexArray;matrixUniformLocation;async init(){const i=y.gl,e=_t.replacePlaceholders(At.FRAGMENT_SHADER,new Map([["fog-color",_t.toVec4(...A.environment.fog.color)],["fog-height",_t.toFloat(A.courseConfig.fogHeight)]]));this.shader=Z.loadFromString(At.VERTEX_SHADER,e,i),[this.matrixUniformLocation]=Z.getUniformLocations(this.shader,i,"u_TransformationMatrix");const[o]=Z.getAttributeLocations(this.shader,i,"a_Position");this.vertexArray=U.createAndBindVertexArray(i),U.bindPositions(At.POSITIONS,o,i),U.bindIndices(At.INDICES,i)}draw(){y.modelViewMatrix.push(),y.modelViewMatrix.multiply(v.createTranslation(...y.cameraPosition));const i=v.multiply(y.modelViewMatrix.current,y.perspectiveMatrix),e=y.gl;e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.depthMask(!1),e.enable(e.BLEND),e.useProgram(this.shader),e.uniformMatrix4fv(this.matrixUniformLocation,!1,i),e.bindVertexArray(this.vertexArray),e.drawElements(e.TRIANGLES,At.INDICES.length,e.UNSIGNED_SHORT,0),y.modelViewMatrix.pop()}}var Rt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Ft={};/*!
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */var Zt;function ne(){return Zt||(Zt=1,function(s){(function(){var i=function(){this.init()};i.prototype={init:function(){var t=this||e;return t._counter=1e3,t._html5AudioPool=[],t.html5PoolSize=10,t._codecs={},t._howls=[],t._muted=!1,t._volume=1,t._canPlayEvent="canplaythrough",t._navigator=typeof window<"u"&&window.navigator?window.navigator:null,t.masterGain=null,t.noAudio=!1,t.usingWebAudio=!0,t.autoSuspend=!0,t.ctx=null,t.autoUnlock=!0,t._setup(),t},volume:function(t){var n=this||e;if(t=parseFloat(t),n.ctx||m(),typeof t<"u"&&t>=0&&t<=1){if(n._volume=t,n._muted)return n;n.usingWebAudio&&n.masterGain.gain.setValueAtTime(t,e.ctx.currentTime);for(var a=0;a<n._howls.length;a++)if(!n._howls[a]._webAudio)for(var l=n._howls[a]._getSoundIds(),u=0;u<l.length;u++){var h=n._howls[a]._soundById(l[u]);h&&h._node&&(h._node.volume=h._volume*t)}return n}return n._volume},mute:function(t){var n=this||e;n.ctx||m(),n._muted=t,n.usingWebAudio&&n.masterGain.gain.setValueAtTime(t?0:n._volume,e.ctx.currentTime);for(var a=0;a<n._howls.length;a++)if(!n._howls[a]._webAudio)for(var l=n._howls[a]._getSoundIds(),u=0;u<l.length;u++){var h=n._howls[a]._soundById(l[u]);h&&h._node&&(h._node.muted=t?!0:h._muted)}return n},stop:function(){for(var t=this||e,n=0;n<t._howls.length;n++)t._howls[n].stop();return t},unload:function(){for(var t=this||e,n=t._howls.length-1;n>=0;n--)t._howls[n].unload();return t.usingWebAudio&&t.ctx&&typeof t.ctx.close<"u"&&(t.ctx.close(),t.ctx=null,m()),t},codecs:function(t){return(this||e)._codecs[t.replace(/^x-/,"")]},_setup:function(){var t=this||e;if(t.state=t.ctx&&t.ctx.state||"suspended",t._autoSuspend(),!t.usingWebAudio)if(typeof Audio<"u")try{var n=new Audio;typeof n.oncanplaythrough>"u"&&(t._canPlayEvent="canplay")}catch{t.noAudio=!0}else t.noAudio=!0;try{var n=new Audio;n.muted&&(t.noAudio=!0)}catch{}return t.noAudio||t._setupCodecs(),t},_setupCodecs:function(){var t=this||e,n=null;try{n=typeof Audio<"u"?new Audio:null}catch{return t}if(!n||typeof n.canPlayType!="function")return t;var a=n.canPlayType("audio/mpeg;").replace(/^no$/,""),l=t._navigator?t._navigator.userAgent:"",u=l.match(/OPR\/(\d+)/g),h=u&&parseInt(u[0].split("/")[1],10)<33,f=l.indexOf("Safari")!==-1&&l.indexOf("Chrome")===-1,I=l.match(/Version\/(.*?) /),g=f&&I&&parseInt(I[1],10)<15;return t._codecs={mp3:!!(!h&&(a||n.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!a,opus:!!n.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!n.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!n.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(n.canPlayType('audio/wav; codecs="1"')||n.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!n.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!n.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(n.canPlayType("audio/x-m4a;")||n.canPlayType("audio/m4a;")||n.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(n.canPlayType("audio/x-m4b;")||n.canPlayType("audio/m4b;")||n.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(n.canPlayType("audio/x-mp4;")||n.canPlayType("audio/mp4;")||n.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!g&&n.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!g&&n.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!n.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(n.canPlayType("audio/x-flac;")||n.canPlayType("audio/flac;")).replace(/^no$/,"")},t},_unlockAudio:function(){var t=this||e;if(!(t._audioUnlocked||!t.ctx)){t._audioUnlocked=!1,t.autoUnlock=!1,!t._mobileUnloaded&&t.ctx.sampleRate!==44100&&(t._mobileUnloaded=!0,t.unload()),t._scratchBuffer=t.ctx.createBuffer(1,1,22050);var n=function(a){for(;t._html5AudioPool.length<t.html5PoolSize;)try{var l=new Audio;l._unlocked=!0,t._releaseHtml5Audio(l)}catch{t.noAudio=!0;break}for(var u=0;u<t._howls.length;u++)if(!t._howls[u]._webAudio)for(var h=t._howls[u]._getSoundIds(),f=0;f<h.length;f++){var I=t._howls[u]._soundById(h[f]);I&&I._node&&!I._node._unlocked&&(I._node._unlocked=!0,I._node.load())}t._autoResume();var g=t.ctx.createBufferSource();g.buffer=t._scratchBuffer,g.connect(t.ctx.destination),typeof g.start>"u"?g.noteOn(0):g.start(0),typeof t.ctx.resume=="function"&&t.ctx.resume(),g.onended=function(){g.disconnect(0),t._audioUnlocked=!0,document.removeEventListener("touchstart",n,!0),document.removeEventListener("touchend",n,!0),document.removeEventListener("click",n,!0),document.removeEventListener("keydown",n,!0);for(var R=0;R<t._howls.length;R++)t._howls[R]._emit("unlock")}};return document.addEventListener("touchstart",n,!0),document.addEventListener("touchend",n,!0),document.addEventListener("click",n,!0),document.addEventListener("keydown",n,!0),t}},_obtainHtml5Audio:function(){var t=this||e;if(t._html5AudioPool.length)return t._html5AudioPool.pop();var n=new Audio().play();return n&&typeof Promise<"u"&&(n instanceof Promise||typeof n.then=="function")&&n.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(t){var n=this||e;return t._unlocked&&n._html5AudioPool.push(t),n},_autoSuspend:function(){var t=this;if(!(!t.autoSuspend||!t.ctx||typeof t.ctx.suspend>"u"||!e.usingWebAudio)){for(var n=0;n<t._howls.length;n++)if(t._howls[n]._webAudio){for(var a=0;a<t._howls[n]._sounds.length;a++)if(!t._howls[n]._sounds[a]._paused)return t}return t._suspendTimer&&clearTimeout(t._suspendTimer),t._suspendTimer=setTimeout(function(){if(t.autoSuspend){t._suspendTimer=null,t.state="suspending";var l=function(){t.state="suspended",t._resumeAfterSuspend&&(delete t._resumeAfterSuspend,t._autoResume())};t.ctx.suspend().then(l,l)}},3e4),t}},_autoResume:function(){var t=this;if(!(!t.ctx||typeof t.ctx.resume>"u"||!e.usingWebAudio))return t.state==="running"&&t.ctx.state!=="interrupted"&&t._suspendTimer?(clearTimeout(t._suspendTimer),t._suspendTimer=null):t.state==="suspended"||t.state==="running"&&t.ctx.state==="interrupted"?(t.ctx.resume().then(function(){t.state="running";for(var n=0;n<t._howls.length;n++)t._howls[n]._emit("resume")}),t._suspendTimer&&(clearTimeout(t._suspendTimer),t._suspendTimer=null)):t.state==="suspending"&&(t._resumeAfterSuspend=!0),t}};var e=new i,o=function(t){var n=this;if(!t.src||t.src.length===0){console.error("An array of source files must be passed with any new Howl.");return}n.init(t)};o.prototype={init:function(t){var n=this;return e.ctx||m(),n._autoplay=t.autoplay||!1,n._format=typeof t.format!="string"?t.format:[t.format],n._html5=t.html5||!1,n._muted=t.mute||!1,n._loop=t.loop||!1,n._pool=t.pool||5,n._preload=typeof t.preload=="boolean"||t.preload==="metadata"?t.preload:!0,n._rate=t.rate||1,n._sprite=t.sprite||{},n._src=typeof t.src!="string"?t.src:[t.src],n._volume=t.volume!==void 0?t.volume:1,n._xhr={method:t.xhr&&t.xhr.method?t.xhr.method:"GET",headers:t.xhr&&t.xhr.headers?t.xhr.headers:null,withCredentials:t.xhr&&t.xhr.withCredentials?t.xhr.withCredentials:!1},n._duration=0,n._state="unloaded",n._sounds=[],n._endTimers={},n._queue=[],n._playLock=!1,n._onend=t.onend?[{fn:t.onend}]:[],n._onfade=t.onfade?[{fn:t.onfade}]:[],n._onload=t.onload?[{fn:t.onload}]:[],n._onloaderror=t.onloaderror?[{fn:t.onloaderror}]:[],n._onplayerror=t.onplayerror?[{fn:t.onplayerror}]:[],n._onpause=t.onpause?[{fn:t.onpause}]:[],n._onplay=t.onplay?[{fn:t.onplay}]:[],n._onstop=t.onstop?[{fn:t.onstop}]:[],n._onmute=t.onmute?[{fn:t.onmute}]:[],n._onvolume=t.onvolume?[{fn:t.onvolume}]:[],n._onrate=t.onrate?[{fn:t.onrate}]:[],n._onseek=t.onseek?[{fn:t.onseek}]:[],n._onunlock=t.onunlock?[{fn:t.onunlock}]:[],n._onresume=[],n._webAudio=e.usingWebAudio&&!n._html5,typeof e.ctx<"u"&&e.ctx&&e.autoUnlock&&e._unlockAudio(),e._howls.push(n),n._autoplay&&n._queue.push({event:"play",action:function(){n.play()}}),n._preload&&n._preload!=="none"&&n.load(),n},load:function(){var t=this,n=null;if(e.noAudio){t._emit("loaderror",null,"No audio support.");return}typeof t._src=="string"&&(t._src=[t._src]);for(var a=0;a<t._src.length;a++){var l,u;if(t._format&&t._format[a])l=t._format[a];else{if(u=t._src[a],typeof u!="string"){t._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}l=/^data:audio\/([^;,]+);/i.exec(u),l||(l=/\.([^.]+)$/.exec(u.split("?",1)[0])),l&&(l=l[1].toLowerCase())}if(l||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),l&&e.codecs(l)){n=t._src[a];break}}if(!n){t._emit("loaderror",null,"No codec support for selected audio sources.");return}return t._src=n,t._state="loading",window.location.protocol==="https:"&&n.slice(0,5)==="http:"&&(t._html5=!0,t._webAudio=!1),new r(t),t._webAudio&&c(t),t},play:function(t,n){var a=this,l=null;if(typeof t=="number")l=t,t=null;else{if(typeof t=="string"&&a._state==="loaded"&&!a._sprite[t])return null;if(typeof t>"u"&&(t="__default",!a._playLock)){for(var u=0,h=0;h<a._sounds.length;h++)a._sounds[h]._paused&&!a._sounds[h]._ended&&(u++,l=a._sounds[h]._id);u===1?t=null:l=null}}var f=l?a._soundById(l):a._inactiveSound();if(!f)return null;if(l&&!t&&(t=f._sprite||"__default"),a._state!=="loaded"){f._sprite=t,f._ended=!1;var I=f._id;return a._queue.push({event:"play",action:function(){a.play(I)}}),I}if(l&&!f._paused)return n||a._loadQueue("play"),f._id;a._webAudio&&e._autoResume();var g=Math.max(0,f._seek>0?f._seek:a._sprite[t][0]/1e3),R=Math.max(0,(a._sprite[t][0]+a._sprite[t][1])/1e3-g),x=R*1e3/Math.abs(f._rate),S=a._sprite[t][0]/1e3,N=(a._sprite[t][0]+a._sprite[t][1])/1e3;f._sprite=t,f._ended=!1;var V=function(){f._paused=!1,f._seek=g,f._start=S,f._stop=N,f._loop=!!(f._loop||a._sprite[t][2])};if(g>=N){a._ended(f);return}var M=f._node;if(a._webAudio){var L=function(){a._playLock=!1,V(),a._refreshBuffer(f);var b=f._muted||a._muted?0:f._volume;M.gain.setValueAtTime(b,e.ctx.currentTime),f._playStart=e.ctx.currentTime,typeof M.bufferSource.start>"u"?f._loop?M.bufferSource.noteGrainOn(0,g,86400):M.bufferSource.noteGrainOn(0,g,R):f._loop?M.bufferSource.start(0,g,86400):M.bufferSource.start(0,g,R),x!==1/0&&(a._endTimers[f._id]=setTimeout(a._ended.bind(a,f),x)),n||setTimeout(function(){a._emit("play",f._id),a._loadQueue()},0)};e.state==="running"&&e.ctx.state!=="interrupted"?L():(a._playLock=!0,a.once("resume",L),a._clearTimer(f._id))}else{var P=function(){M.currentTime=g,M.muted=f._muted||a._muted||e._muted||M.muted,M.volume=f._volume*e.volume(),M.playbackRate=f._rate;try{var b=M.play();if(b&&typeof Promise<"u"&&(b instanceof Promise||typeof b.then=="function")?(a._playLock=!0,V(),b.then(function(){a._playLock=!1,M._unlocked=!0,n?a._loadQueue():a._emit("play",f._id)}).catch(function(){a._playLock=!1,a._emit("playerror",f._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),f._ended=!0,f._paused=!0})):n||(a._playLock=!1,V(),a._emit("play",f._id)),M.playbackRate=f._rate,M.paused){a._emit("playerror",f._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}t!=="__default"||f._loop?a._endTimers[f._id]=setTimeout(a._ended.bind(a,f),x):(a._endTimers[f._id]=function(){a._ended(f),M.removeEventListener("ended",a._endTimers[f._id],!1)},M.addEventListener("ended",a._endTimers[f._id],!1))}catch(k){a._emit("playerror",f._id,k)}};M.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(M.src=a._src,M.load());var C=window&&window.ejecta||!M.readyState&&e._navigator.isCocoonJS;if(M.readyState>=3||C)P();else{a._playLock=!0,a._state="loading";var D=function(){a._state="loaded",P(),M.removeEventListener(e._canPlayEvent,D,!1)};M.addEventListener(e._canPlayEvent,D,!1),a._clearTimer(f._id)}}return f._id},pause:function(t){var n=this;if(n._state!=="loaded"||n._playLock)return n._queue.push({event:"pause",action:function(){n.pause(t)}}),n;for(var a=n._getSoundIds(t),l=0;l<a.length;l++){n._clearTimer(a[l]);var u=n._soundById(a[l]);if(u&&!u._paused&&(u._seek=n.seek(a[l]),u._rateSeek=0,u._paused=!0,n._stopFade(a[l]),u._node))if(n._webAudio){if(!u._node.bufferSource)continue;typeof u._node.bufferSource.stop>"u"?u._node.bufferSource.noteOff(0):u._node.bufferSource.stop(0),n._cleanBuffer(u._node)}else(!isNaN(u._node.duration)||u._node.duration===1/0)&&u._node.pause();arguments[1]||n._emit("pause",u?u._id:null)}return n},stop:function(t,n){var a=this;if(a._state!=="loaded"||a._playLock)return a._queue.push({event:"stop",action:function(){a.stop(t)}}),a;for(var l=a._getSoundIds(t),u=0;u<l.length;u++){a._clearTimer(l[u]);var h=a._soundById(l[u]);h&&(h._seek=h._start||0,h._rateSeek=0,h._paused=!0,h._ended=!0,a._stopFade(l[u]),h._node&&(a._webAudio?h._node.bufferSource&&(typeof h._node.bufferSource.stop>"u"?h._node.bufferSource.noteOff(0):h._node.bufferSource.stop(0),a._cleanBuffer(h._node)):(!isNaN(h._node.duration)||h._node.duration===1/0)&&(h._node.currentTime=h._start||0,h._node.pause(),h._node.duration===1/0&&a._clearSound(h._node))),n||a._emit("stop",h._id))}return a},mute:function(t,n){var a=this;if(a._state!=="loaded"||a._playLock)return a._queue.push({event:"mute",action:function(){a.mute(t,n)}}),a;if(typeof n>"u")if(typeof t=="boolean")a._muted=t;else return a._muted;for(var l=a._getSoundIds(n),u=0;u<l.length;u++){var h=a._soundById(l[u]);h&&(h._muted=t,h._interval&&a._stopFade(h._id),a._webAudio&&h._node?h._node.gain.setValueAtTime(t?0:h._volume,e.ctx.currentTime):h._node&&(h._node.muted=e._muted?!0:t),a._emit("mute",h._id))}return a},volume:function(){var t=this,n=arguments,a,l;if(n.length===0)return t._volume;if(n.length===1||n.length===2&&typeof n[1]>"u"){var u=t._getSoundIds(),h=u.indexOf(n[0]);h>=0?l=parseInt(n[0],10):a=parseFloat(n[0])}else n.length>=2&&(a=parseFloat(n[0]),l=parseInt(n[1],10));var f;if(typeof a<"u"&&a>=0&&a<=1){if(t._state!=="loaded"||t._playLock)return t._queue.push({event:"volume",action:function(){t.volume.apply(t,n)}}),t;typeof l>"u"&&(t._volume=a),l=t._getSoundIds(l);for(var I=0;I<l.length;I++)f=t._soundById(l[I]),f&&(f._volume=a,n[2]||t._stopFade(l[I]),t._webAudio&&f._node&&!f._muted?f._node.gain.setValueAtTime(a,e.ctx.currentTime):f._node&&!f._muted&&(f._node.volume=a*e.volume()),t._emit("volume",f._id))}else return f=l?t._soundById(l):t._sounds[0],f?f._volume:0;return t},fade:function(t,n,a,l){var u=this;if(u._state!=="loaded"||u._playLock)return u._queue.push({event:"fade",action:function(){u.fade(t,n,a,l)}}),u;t=Math.min(Math.max(0,parseFloat(t)),1),n=Math.min(Math.max(0,parseFloat(n)),1),a=parseFloat(a),u.volume(t,l);for(var h=u._getSoundIds(l),f=0;f<h.length;f++){var I=u._soundById(h[f]);if(I){if(l||u._stopFade(h[f]),u._webAudio&&!I._muted){var g=e.ctx.currentTime,R=g+a/1e3;I._volume=t,I._node.gain.setValueAtTime(t,g),I._node.gain.linearRampToValueAtTime(n,R)}u._startFadeInterval(I,t,n,a,h[f],typeof l>"u")}}return u},_startFadeInterval:function(t,n,a,l,u,h){var f=this,I=n,g=a-n,R=Math.abs(g/.01),x=Math.max(4,R>0?l/R:l),S=Date.now();t._fadeTo=a,t._interval=setInterval(function(){var N=(Date.now()-S)/l;S=Date.now(),I+=g*N,I=Math.round(I*100)/100,g<0?I=Math.max(a,I):I=Math.min(a,I),f._webAudio?t._volume=I:f.volume(I,t._id,!0),h&&(f._volume=I),(a<n&&I<=a||a>n&&I>=a)&&(clearInterval(t._interval),t._interval=null,t._fadeTo=null,f.volume(a,t._id),f._emit("fade",t._id))},x)},_stopFade:function(t){var n=this,a=n._soundById(t);return a&&a._interval&&(n._webAudio&&a._node.gain.cancelScheduledValues(e.ctx.currentTime),clearInterval(a._interval),a._interval=null,n.volume(a._fadeTo,t),a._fadeTo=null,n._emit("fade",t)),n},loop:function(){var t=this,n=arguments,a,l,u;if(n.length===0)return t._loop;if(n.length===1)if(typeof n[0]=="boolean")a=n[0],t._loop=a;else return u=t._soundById(parseInt(n[0],10)),u?u._loop:!1;else n.length===2&&(a=n[0],l=parseInt(n[1],10));for(var h=t._getSoundIds(l),f=0;f<h.length;f++)u=t._soundById(h[f]),u&&(u._loop=a,t._webAudio&&u._node&&u._node.bufferSource&&(u._node.bufferSource.loop=a,a&&(u._node.bufferSource.loopStart=u._start||0,u._node.bufferSource.loopEnd=u._stop,t.playing(h[f])&&(t.pause(h[f],!0),t.play(h[f],!0)))));return t},rate:function(){var t=this,n=arguments,a,l;if(n.length===0)l=t._sounds[0]._id;else if(n.length===1){var u=t._getSoundIds(),h=u.indexOf(n[0]);h>=0?l=parseInt(n[0],10):a=parseFloat(n[0])}else n.length===2&&(a=parseFloat(n[0]),l=parseInt(n[1],10));var f;if(typeof a=="number"){if(t._state!=="loaded"||t._playLock)return t._queue.push({event:"rate",action:function(){t.rate.apply(t,n)}}),t;typeof l>"u"&&(t._rate=a),l=t._getSoundIds(l);for(var I=0;I<l.length;I++)if(f=t._soundById(l[I]),f){t.playing(l[I])&&(f._rateSeek=t.seek(l[I]),f._playStart=t._webAudio?e.ctx.currentTime:f._playStart),f._rate=a,t._webAudio&&f._node&&f._node.bufferSource?f._node.bufferSource.playbackRate.setValueAtTime(a,e.ctx.currentTime):f._node&&(f._node.playbackRate=a);var g=t.seek(l[I]),R=(t._sprite[f._sprite][0]+t._sprite[f._sprite][1])/1e3-g,x=R*1e3/Math.abs(f._rate);(t._endTimers[l[I]]||!f._paused)&&(t._clearTimer(l[I]),t._endTimers[l[I]]=setTimeout(t._ended.bind(t,f),x)),t._emit("rate",f._id)}}else return f=t._soundById(l),f?f._rate:t._rate;return t},seek:function(){var t=this,n=arguments,a,l;if(n.length===0)t._sounds.length&&(l=t._sounds[0]._id);else if(n.length===1){var u=t._getSoundIds(),h=u.indexOf(n[0]);h>=0?l=parseInt(n[0],10):t._sounds.length&&(l=t._sounds[0]._id,a=parseFloat(n[0]))}else n.length===2&&(a=parseFloat(n[0]),l=parseInt(n[1],10));if(typeof l>"u")return 0;if(typeof a=="number"&&(t._state!=="loaded"||t._playLock))return t._queue.push({event:"seek",action:function(){t.seek.apply(t,n)}}),t;var f=t._soundById(l);if(f)if(typeof a=="number"&&a>=0){var I=t.playing(l);I&&t.pause(l,!0),f._seek=a,f._ended=!1,t._clearTimer(l),!t._webAudio&&f._node&&!isNaN(f._node.duration)&&(f._node.currentTime=a);var g=function(){I&&t.play(l,!0),t._emit("seek",l)};if(I&&!t._webAudio){var R=function(){t._playLock?setTimeout(R,0):g()};setTimeout(R,0)}else g()}else if(t._webAudio){var x=t.playing(l)?e.ctx.currentTime-f._playStart:0,S=f._rateSeek?f._rateSeek-f._seek:0;return f._seek+(S+x*Math.abs(f._rate))}else return f._node.currentTime;return t},playing:function(t){var n=this;if(typeof t=="number"){var a=n._soundById(t);return a?!a._paused:!1}for(var l=0;l<n._sounds.length;l++)if(!n._sounds[l]._paused)return!0;return!1},duration:function(t){var n=this,a=n._duration,l=n._soundById(t);return l&&(a=n._sprite[l._sprite][1]/1e3),a},state:function(){return this._state},unload:function(){for(var t=this,n=t._sounds,a=0;a<n.length;a++)n[a]._paused||t.stop(n[a]._id),t._webAudio||(t._clearSound(n[a]._node),n[a]._node.removeEventListener("error",n[a]._errorFn,!1),n[a]._node.removeEventListener(e._canPlayEvent,n[a]._loadFn,!1),n[a]._node.removeEventListener("ended",n[a]._endFn,!1),e._releaseHtml5Audio(n[a]._node)),delete n[a]._node,t._clearTimer(n[a]._id);var l=e._howls.indexOf(t);l>=0&&e._howls.splice(l,1);var u=!0;for(a=0;a<e._howls.length;a++)if(e._howls[a]._src===t._src||t._src.indexOf(e._howls[a]._src)>=0){u=!1;break}return _&&u&&delete _[t._src],e.noAudio=!1,t._state="unloaded",t._sounds=[],t=null,null},on:function(t,n,a,l){var u=this,h=u["_on"+t];return typeof n=="function"&&h.push(l?{id:a,fn:n,once:l}:{id:a,fn:n}),u},off:function(t,n,a){var l=this,u=l["_on"+t],h=0;if(typeof n=="number"&&(a=n,n=null),n||a)for(h=0;h<u.length;h++){var f=a===u[h].id;if(n===u[h].fn&&f||!n&&f){u.splice(h,1);break}}else if(t)l["_on"+t]=[];else{var I=Object.keys(l);for(h=0;h<I.length;h++)I[h].indexOf("_on")===0&&Array.isArray(l[I[h]])&&(l[I[h]]=[])}return l},once:function(t,n,a){var l=this;return l.on(t,n,a,1),l},_emit:function(t,n,a){for(var l=this,u=l["_on"+t],h=u.length-1;h>=0;h--)(!u[h].id||u[h].id===n||t==="load")&&(setTimeout(function(f){f.call(this,n,a)}.bind(l,u[h].fn),0),u[h].once&&l.off(t,u[h].fn,u[h].id));return l._loadQueue(t),l},_loadQueue:function(t){var n=this;if(n._queue.length>0){var a=n._queue[0];a.event===t&&(n._queue.shift(),n._loadQueue()),t||a.action()}return n},_ended:function(t){var n=this,a=t._sprite;if(!n._webAudio&&t._node&&!t._node.paused&&!t._node.ended&&t._node.currentTime<t._stop)return setTimeout(n._ended.bind(n,t),100),n;var l=!!(t._loop||n._sprite[a][2]);if(n._emit("end",t._id),!n._webAudio&&l&&n.stop(t._id,!0).play(t._id),n._webAudio&&l){n._emit("play",t._id),t._seek=t._start||0,t._rateSeek=0,t._playStart=e.ctx.currentTime;var u=(t._stop-t._start)*1e3/Math.abs(t._rate);n._endTimers[t._id]=setTimeout(n._ended.bind(n,t),u)}return n._webAudio&&!l&&(t._paused=!0,t._ended=!0,t._seek=t._start||0,t._rateSeek=0,n._clearTimer(t._id),n._cleanBuffer(t._node),e._autoSuspend()),!n._webAudio&&!l&&n.stop(t._id,!0),n},_clearTimer:function(t){var n=this;if(n._endTimers[t]){if(typeof n._endTimers[t]!="function")clearTimeout(n._endTimers[t]);else{var a=n._soundById(t);a&&a._node&&a._node.removeEventListener("ended",n._endTimers[t],!1)}delete n._endTimers[t]}return n},_soundById:function(t){for(var n=this,a=0;a<n._sounds.length;a++)if(t===n._sounds[a]._id)return n._sounds[a];return null},_inactiveSound:function(){var t=this;t._drain();for(var n=0;n<t._sounds.length;n++)if(t._sounds[n]._ended)return t._sounds[n].reset();return new r(t)},_drain:function(){var t=this,n=t._pool,a=0,l=0;if(!(t._sounds.length<n)){for(l=0;l<t._sounds.length;l++)t._sounds[l]._ended&&a++;for(l=t._sounds.length-1;l>=0;l--){if(a<=n)return;t._sounds[l]._ended&&(t._webAudio&&t._sounds[l]._node&&t._sounds[l]._node.disconnect(0),t._sounds.splice(l,1),a--)}}},_getSoundIds:function(t){var n=this;if(typeof t>"u"){for(var a=[],l=0;l<n._sounds.length;l++)a.push(n._sounds[l]._id);return a}else return[t]},_refreshBuffer:function(t){var n=this;return t._node.bufferSource=e.ctx.createBufferSource(),t._node.bufferSource.buffer=_[n._src],t._panner?t._node.bufferSource.connect(t._panner):t._node.bufferSource.connect(t._node),t._node.bufferSource.loop=t._loop,t._loop&&(t._node.bufferSource.loopStart=t._start||0,t._node.bufferSource.loopEnd=t._stop||0),t._node.bufferSource.playbackRate.setValueAtTime(t._rate,e.ctx.currentTime),n},_cleanBuffer:function(t){var n=this,a=e._navigator&&e._navigator.vendor.indexOf("Apple")>=0;if(!t.bufferSource)return n;if(e._scratchBuffer&&t.bufferSource&&(t.bufferSource.onended=null,t.bufferSource.disconnect(0),a))try{t.bufferSource.buffer=e._scratchBuffer}catch{}return t.bufferSource=null,n},_clearSound:function(t){var n=/MSIE |Trident\//.test(e._navigator&&e._navigator.userAgent);n||(t.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var r=function(t){this._parent=t,this.init()};r.prototype={init:function(){var t=this,n=t._parent;return t._muted=n._muted,t._loop=n._loop,t._volume=n._volume,t._rate=n._rate,t._seek=0,t._paused=!0,t._ended=!0,t._sprite="__default",t._id=++e._counter,n._sounds.push(t),t.create(),t},create:function(){var t=this,n=t._parent,a=e._muted||t._muted||t._parent._muted?0:t._volume;return n._webAudio?(t._node=typeof e.ctx.createGain>"u"?e.ctx.createGainNode():e.ctx.createGain(),t._node.gain.setValueAtTime(a,e.ctx.currentTime),t._node.paused=!0,t._node.connect(e.masterGain)):e.noAudio||(t._node=e._obtainHtml5Audio(),t._errorFn=t._errorListener.bind(t),t._node.addEventListener("error",t._errorFn,!1),t._loadFn=t._loadListener.bind(t),t._node.addEventListener(e._canPlayEvent,t._loadFn,!1),t._endFn=t._endListener.bind(t),t._node.addEventListener("ended",t._endFn,!1),t._node.src=n._src,t._node.preload=n._preload===!0?"auto":n._preload,t._node.volume=a*e.volume(),t._node.load()),t},reset:function(){var t=this,n=t._parent;return t._muted=n._muted,t._loop=n._loop,t._volume=n._volume,t._rate=n._rate,t._seek=0,t._rateSeek=0,t._paused=!0,t._ended=!0,t._sprite="__default",t._id=++e._counter,t},_errorListener:function(){var t=this;t._parent._emit("loaderror",t._id,t._node.error?t._node.error.code:0),t._node.removeEventListener("error",t._errorFn,!1)},_loadListener:function(){var t=this,n=t._parent;n._duration=Math.ceil(t._node.duration*10)/10,Object.keys(n._sprite).length===0&&(n._sprite={__default:[0,n._duration*1e3]}),n._state!=="loaded"&&(n._state="loaded",n._emit("load"),n._loadQueue()),t._node.removeEventListener(e._canPlayEvent,t._loadFn,!1)},_endListener:function(){var t=this,n=t._parent;n._duration===1/0&&(n._duration=Math.ceil(t._node.duration*10)/10,n._sprite.__default[1]===1/0&&(n._sprite.__default[1]=n._duration*1e3),n._ended(t)),t._node.removeEventListener("ended",t._endFn,!1)}};var _={},c=function(t){var n=t._src;if(_[n]){t._duration=_[n].duration,d(t);return}if(/^data:[^;]+;base64,/.test(n)){for(var a=atob(n.split(",")[1]),l=new Uint8Array(a.length),u=0;u<a.length;++u)l[u]=a.charCodeAt(u);p(l.buffer,t)}else{var h=new XMLHttpRequest;h.open(t._xhr.method,n,!0),h.withCredentials=t._xhr.withCredentials,h.responseType="arraybuffer",t._xhr.headers&&Object.keys(t._xhr.headers).forEach(function(f){h.setRequestHeader(f,t._xhr.headers[f])}),h.onload=function(){var f=(h.status+"")[0];if(f!=="0"&&f!=="2"&&f!=="3"){t._emit("loaderror",null,"Failed loading audio file with status: "+h.status+".");return}p(h.response,t)},h.onerror=function(){t._webAudio&&(t._html5=!0,t._webAudio=!1,t._sounds=[],delete _[n],t.load())},T(h)}},T=function(t){try{t.send()}catch{t.onerror()}},p=function(t,n){var a=function(){n._emit("loaderror",null,"Decoding audio data failed.")},l=function(u){u&&n._sounds.length>0?(_[n._src]=u,d(n,u)):a()};typeof Promise<"u"&&e.ctx.decodeAudioData.length===1?e.ctx.decodeAudioData(t).then(l).catch(a):e.ctx.decodeAudioData(t,l,a)},d=function(t,n){n&&!t._duration&&(t._duration=n.duration),Object.keys(t._sprite).length===0&&(t._sprite={__default:[0,t._duration*1e3]}),t._state!=="loaded"&&(t._state="loaded",t._emit("load"),t._loadQueue())},m=function(){if(e.usingWebAudio){try{typeof AudioContext<"u"?e.ctx=new AudioContext:typeof webkitAudioContext<"u"?e.ctx=new webkitAudioContext:e.usingWebAudio=!1}catch{e.usingWebAudio=!1}e.ctx||(e.usingWebAudio=!1);var t=/iP(hone|od|ad)/.test(e._navigator&&e._navigator.platform),n=e._navigator&&e._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),a=n?parseInt(n[1],10):null;if(t&&a&&a<9){var l=/safari/.test(e._navigator&&e._navigator.userAgent.toLowerCase());e._navigator&&!l&&(e.usingWebAudio=!1)}e.usingWebAudio&&(e.masterGain=typeof e.ctx.createGain>"u"?e.ctx.createGainNode():e.ctx.createGain(),e.masterGain.gain.setValueAtTime(e._muted?0:e._volume,e.ctx.currentTime),e.masterGain.connect(e.ctx.destination)),e._setup()}};s.Howler=e,s.Howl=o,typeof Rt<"u"?(Rt.HowlerGlobal=i,Rt.Howler=e,Rt.Howl=o,Rt.Sound=r):typeof window<"u"&&(window.HowlerGlobal=i,window.Howler=e,window.Howl=o,window.Sound=r)})();/*!
 *  Spatial Plugin - Adds support for stereo and 3D audio where Web Audio is supported.
 *  
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(){HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(e){var o=this;if(!o.ctx||!o.ctx.listener)return o;for(var r=o._howls.length-1;r>=0;r--)o._howls[r].stereo(e);return o},HowlerGlobal.prototype.pos=function(e,o,r){var _=this;if(!_.ctx||!_.ctx.listener)return _;if(o=typeof o!="number"?_._pos[1]:o,r=typeof r!="number"?_._pos[2]:r,typeof e=="number")_._pos=[e,o,r],typeof _.ctx.listener.positionX<"u"?(_.ctx.listener.positionX.setTargetAtTime(_._pos[0],Howler.ctx.currentTime,.1),_.ctx.listener.positionY.setTargetAtTime(_._pos[1],Howler.ctx.currentTime,.1),_.ctx.listener.positionZ.setTargetAtTime(_._pos[2],Howler.ctx.currentTime,.1)):_.ctx.listener.setPosition(_._pos[0],_._pos[1],_._pos[2]);else return _._pos;return _},HowlerGlobal.prototype.orientation=function(e,o,r,_,c,T){var p=this;if(!p.ctx||!p.ctx.listener)return p;var d=p._orientation;if(o=typeof o!="number"?d[1]:o,r=typeof r!="number"?d[2]:r,_=typeof _!="number"?d[3]:_,c=typeof c!="number"?d[4]:c,T=typeof T!="number"?d[5]:T,typeof e=="number")p._orientation=[e,o,r,_,c,T],typeof p.ctx.listener.forwardX<"u"?(p.ctx.listener.forwardX.setTargetAtTime(e,Howler.ctx.currentTime,.1),p.ctx.listener.forwardY.setTargetAtTime(o,Howler.ctx.currentTime,.1),p.ctx.listener.forwardZ.setTargetAtTime(r,Howler.ctx.currentTime,.1),p.ctx.listener.upX.setTargetAtTime(_,Howler.ctx.currentTime,.1),p.ctx.listener.upY.setTargetAtTime(c,Howler.ctx.currentTime,.1),p.ctx.listener.upZ.setTargetAtTime(T,Howler.ctx.currentTime,.1)):p.ctx.listener.setOrientation(e,o,r,_,c,T);else return d;return p},Howl.prototype.init=function(e){return function(o){var r=this;return r._orientation=o.orientation||[1,0,0],r._stereo=o.stereo||null,r._pos=o.pos||null,r._pannerAttr={coneInnerAngle:typeof o.coneInnerAngle<"u"?o.coneInnerAngle:360,coneOuterAngle:typeof o.coneOuterAngle<"u"?o.coneOuterAngle:360,coneOuterGain:typeof o.coneOuterGain<"u"?o.coneOuterGain:0,distanceModel:typeof o.distanceModel<"u"?o.distanceModel:"inverse",maxDistance:typeof o.maxDistance<"u"?o.maxDistance:1e4,panningModel:typeof o.panningModel<"u"?o.panningModel:"HRTF",refDistance:typeof o.refDistance<"u"?o.refDistance:1,rolloffFactor:typeof o.rolloffFactor<"u"?o.rolloffFactor:1},r._onstereo=o.onstereo?[{fn:o.onstereo}]:[],r._onpos=o.onpos?[{fn:o.onpos}]:[],r._onorientation=o.onorientation?[{fn:o.onorientation}]:[],e.call(this,o)}}(Howl.prototype.init),Howl.prototype.stereo=function(e,o){var r=this;if(!r._webAudio)return r;if(r._state!=="loaded")return r._queue.push({event:"stereo",action:function(){r.stereo(e,o)}}),r;var _=typeof Howler.ctx.createStereoPanner>"u"?"spatial":"stereo";if(typeof o>"u")if(typeof e=="number")r._stereo=e,r._pos=[e,0,0];else return r._stereo;for(var c=r._getSoundIds(o),T=0;T<c.length;T++){var p=r._soundById(c[T]);if(p)if(typeof e=="number")p._stereo=e,p._pos=[e,0,0],p._node&&(p._pannerAttr.panningModel="equalpower",(!p._panner||!p._panner.pan)&&i(p,_),_==="spatial"?typeof p._panner.positionX<"u"?(p._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),p._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),p._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):p._panner.setPosition(e,0,0):p._panner.pan.setValueAtTime(e,Howler.ctx.currentTime)),r._emit("stereo",p._id);else return p._stereo}return r},Howl.prototype.pos=function(e,o,r,_){var c=this;if(!c._webAudio)return c;if(c._state!=="loaded")return c._queue.push({event:"pos",action:function(){c.pos(e,o,r,_)}}),c;if(o=typeof o!="number"?0:o,r=typeof r!="number"?-.5:r,typeof _>"u")if(typeof e=="number")c._pos=[e,o,r];else return c._pos;for(var T=c._getSoundIds(_),p=0;p<T.length;p++){var d=c._soundById(T[p]);if(d)if(typeof e=="number")d._pos=[e,o,r],d._node&&((!d._panner||d._panner.pan)&&i(d,"spatial"),typeof d._panner.positionX<"u"?(d._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),d._panner.positionY.setValueAtTime(o,Howler.ctx.currentTime),d._panner.positionZ.setValueAtTime(r,Howler.ctx.currentTime)):d._panner.setPosition(e,o,r)),c._emit("pos",d._id);else return d._pos}return c},Howl.prototype.orientation=function(e,o,r,_){var c=this;if(!c._webAudio)return c;if(c._state!=="loaded")return c._queue.push({event:"orientation",action:function(){c.orientation(e,o,r,_)}}),c;if(o=typeof o!="number"?c._orientation[1]:o,r=typeof r!="number"?c._orientation[2]:r,typeof _>"u")if(typeof e=="number")c._orientation=[e,o,r];else return c._orientation;for(var T=c._getSoundIds(_),p=0;p<T.length;p++){var d=c._soundById(T[p]);if(d)if(typeof e=="number")d._orientation=[e,o,r],d._node&&(d._panner||(d._pos||(d._pos=c._pos||[0,0,-.5]),i(d,"spatial")),typeof d._panner.orientationX<"u"?(d._panner.orientationX.setValueAtTime(e,Howler.ctx.currentTime),d._panner.orientationY.setValueAtTime(o,Howler.ctx.currentTime),d._panner.orientationZ.setValueAtTime(r,Howler.ctx.currentTime)):d._panner.setOrientation(e,o,r)),c._emit("orientation",d._id);else return d._orientation}return c},Howl.prototype.pannerAttr=function(){var e=this,o=arguments,r,_,c;if(!e._webAudio)return e;if(o.length===0)return e._pannerAttr;if(o.length===1)if(typeof o[0]=="object")r=o[0],typeof _>"u"&&(r.pannerAttr||(r.pannerAttr={coneInnerAngle:r.coneInnerAngle,coneOuterAngle:r.coneOuterAngle,coneOuterGain:r.coneOuterGain,distanceModel:r.distanceModel,maxDistance:r.maxDistance,refDistance:r.refDistance,rolloffFactor:r.rolloffFactor,panningModel:r.panningModel}),e._pannerAttr={coneInnerAngle:typeof r.pannerAttr.coneInnerAngle<"u"?r.pannerAttr.coneInnerAngle:e._coneInnerAngle,coneOuterAngle:typeof r.pannerAttr.coneOuterAngle<"u"?r.pannerAttr.coneOuterAngle:e._coneOuterAngle,coneOuterGain:typeof r.pannerAttr.coneOuterGain<"u"?r.pannerAttr.coneOuterGain:e._coneOuterGain,distanceModel:typeof r.pannerAttr.distanceModel<"u"?r.pannerAttr.distanceModel:e._distanceModel,maxDistance:typeof r.pannerAttr.maxDistance<"u"?r.pannerAttr.maxDistance:e._maxDistance,refDistance:typeof r.pannerAttr.refDistance<"u"?r.pannerAttr.refDistance:e._refDistance,rolloffFactor:typeof r.pannerAttr.rolloffFactor<"u"?r.pannerAttr.rolloffFactor:e._rolloffFactor,panningModel:typeof r.pannerAttr.panningModel<"u"?r.pannerAttr.panningModel:e._panningModel});else return c=e._soundById(parseInt(o[0],10)),c?c._pannerAttr:e._pannerAttr;else o.length===2&&(r=o[0],_=parseInt(o[1],10));for(var T=e._getSoundIds(_),p=0;p<T.length;p++)if(c=e._soundById(T[p]),c){var d=c._pannerAttr;d={coneInnerAngle:typeof r.coneInnerAngle<"u"?r.coneInnerAngle:d.coneInnerAngle,coneOuterAngle:typeof r.coneOuterAngle<"u"?r.coneOuterAngle:d.coneOuterAngle,coneOuterGain:typeof r.coneOuterGain<"u"?r.coneOuterGain:d.coneOuterGain,distanceModel:typeof r.distanceModel<"u"?r.distanceModel:d.distanceModel,maxDistance:typeof r.maxDistance<"u"?r.maxDistance:d.maxDistance,refDistance:typeof r.refDistance<"u"?r.refDistance:d.refDistance,rolloffFactor:typeof r.rolloffFactor<"u"?r.rolloffFactor:d.rolloffFactor,panningModel:typeof r.panningModel<"u"?r.panningModel:d.panningModel};var m=c._panner;m||(c._pos||(c._pos=e._pos||[0,0,-.5]),i(c,"spatial"),m=c._panner),m.coneInnerAngle=d.coneInnerAngle,m.coneOuterAngle=d.coneOuterAngle,m.coneOuterGain=d.coneOuterGain,m.distanceModel=d.distanceModel,m.maxDistance=d.maxDistance,m.refDistance=d.refDistance,m.rolloffFactor=d.rolloffFactor,m.panningModel=d.panningModel}return e},Sound.prototype.init=function(e){return function(){var o=this,r=o._parent;o._orientation=r._orientation,o._stereo=r._stereo,o._pos=r._pos,o._pannerAttr=r._pannerAttr,e.call(this),o._stereo?r.stereo(o._stereo):o._pos&&r.pos(o._pos[0],o._pos[1],o._pos[2],o._id)}}(Sound.prototype.init),Sound.prototype.reset=function(e){return function(){var o=this,r=o._parent;return o._orientation=r._orientation,o._stereo=r._stereo,o._pos=r._pos,o._pannerAttr=r._pannerAttr,o._stereo?r.stereo(o._stereo):o._pos?r.pos(o._pos[0],o._pos[1],o._pos[2],o._id):o._panner&&(o._panner.disconnect(0),o._panner=void 0,r._refreshBuffer(o)),e.call(this)}}(Sound.prototype.reset);var i=function(e,o){o=o||"spatial",o==="spatial"?(e._panner=Howler.ctx.createPanner(),e._panner.coneInnerAngle=e._pannerAttr.coneInnerAngle,e._panner.coneOuterAngle=e._pannerAttr.coneOuterAngle,e._panner.coneOuterGain=e._pannerAttr.coneOuterGain,e._panner.distanceModel=e._pannerAttr.distanceModel,e._panner.maxDistance=e._pannerAttr.maxDistance,e._panner.refDistance=e._pannerAttr.refDistance,e._panner.rolloffFactor=e._pannerAttr.rolloffFactor,e._panner.panningModel=e._pannerAttr.panningModel,typeof e._panner.positionX<"u"?(e._panner.positionX.setValueAtTime(e._pos[0],Howler.ctx.currentTime),e._panner.positionY.setValueAtTime(e._pos[1],Howler.ctx.currentTime),e._panner.positionZ.setValueAtTime(e._pos[2],Howler.ctx.currentTime)):e._panner.setPosition(e._pos[0],e._pos[1],e._pos[2]),typeof e._panner.orientationX<"u"?(e._panner.orientationX.setValueAtTime(e._orientation[0],Howler.ctx.currentTime),e._panner.orientationY.setValueAtTime(e._orientation[1],Howler.ctx.currentTime),e._panner.orientationZ.setValueAtTime(e._orientation[2],Howler.ctx.currentTime)):e._panner.setOrientation(e._orientation[0],e._orientation[1],e._orientation[2])):(e._panner=Howler.ctx.createStereoPanner(),e._panner.pan.setValueAtTime(e._stereo,Howler.ctx.currentTime)),e._panner.connect(e._node),e._paused||e._parent.pause(e._id,!0).play(e._id,!0)}})()}(Ft)),Ft}var Pt=ne();class oe{racingMusic;winningMusic;losingMusic;init(){this.racingMusic=new Pt.Howl({src:["assets/music/racing.mp3"],loop:!0}),this.winningMusic=new Pt.Howl({src:["assets/music/winning.mp3"],loop:!0}),this.losingMusic=new Pt.Howl({src:["assets/music/losing.mp3"],loop:!0})}playRacingMusic(){this.winningMusic.stop(),this.losingMusic.stop(),this.racingMusic.play()}playWinningMusic(){this.winningMusic.play(),this.losingMusic.stop(),this.racingMusic.stop()}playLosingMusic(){this.winningMusic.stop(),this.losingMusic.play(),this.racingMusic.stop()}fadeOut(i){this.winningMusic.playing()&&this.winningMusic.fade(this.winningMusic.volume(),0,i),this.losingMusic.playing()&&this.losingMusic.fade(this.losingMusic.volume(),0,i),this.racingMusic.playing()&&this.racingMusic.fade(this.racingMusic.volume(),0,i)}}class re{sounds;constructor(){this.sounds=new Map}init(){this.sounds.set(it.PICKUP_1,this.loadSound("pickup1")),this.sounds.set(it.PICKUP_2,this.loadSound("pickup2")),this.sounds.set(it.PICKUP_3,this.loadSound("pickup3")),this.sounds.set(it.TREE_HIT,this.loadSound("tree-hit")),this.sounds.set(it.TERRAIN_ICE,this.loadSound("terrain-ice",!0)),this.sounds.set(it.TERRAIN_ROCK,this.loadSound("terrain-rock",!0)),this.sounds.set(it.TERRAIN_SNOW,this.loadSound("terrain-snow",!0))}playSound(i){this.findHowl(i).play()}stopSound(i){this.findHowl(i).stop()}loadSound(i,e=!1){return new Pt.Howl({src:[`assets/sound/${i}.mp3`],loop:e})}findHowl(i){const e=this.sounds.get(i);if(!e)throw new Error("Unknown sound: "+i);return e}}var Ot=(s=>(s.TUX="tux",s))(Ot||{}),Bt=(s=>(s.INTRO="intro",s.OUTRO_WIN="outro-win",s.OUTRO_DEFEAT="outro-defeat",s))(Bt||{});class Dt{static BACKGROUND_COLOR=[.4,.6,.8,1];static BREAKING_TARGET_SPEED=3;skybox;fogPanel;camera;trackMarks;character;musicPlayer;introAnimation;outroAnimation;currentTerrain;async init(i,e){A.environment=e,A.courseConfig=i,A.state=J.INTRO,A.collectedItems=0,A.course=await Ht.load(),await A.course.init(),A.items=await Vt.load(),await A.items.init(),A.player=new W,A.player.init(),A.control=new $t,A.soundPlayer=new re,A.soundPlayer.init(),this.skybox=new H,await this.skybox.init(),this.fogPanel=new At,await this.fogPanel.init(),this.camera=new Y,this.camera.init(),this.character=await Gt.load(Ot.TUX),await this.character.init(),this.trackMarks=new j,await this.trackMarks.init(),this.musicPlayer=new oe,this.musicPlayer.init(),this.musicPlayer.playRacingMusic(),this.introAnimation=await Ct.load(Ot.TUX,Bt.INTRO),this.introAnimation.start(),this.outroAnimation=await Ct.load(Ot.TUX,Bt.OUTRO_WIN)}update(i,e,o){A.control.update(e,o);const r=this.updateGameState(i);this.camera.update(i),this.draw(r)}draw(i){U.clearRenderContext(Dt.BACKGROUND_COLOR,y.gl),this.skybox.draw(),this.fogPanel.draw(),A.course.draw(),this.trackMarks.draw(),A.items.draw(),this.character.draw(i)}updateGameState(i){switch(A.state){case J.INTRO:return this.introAnimation.update(i),this.introAnimation.active||(A.state=J.RACING,A.startTime=Date.now(),this.camera.viewMode=yt.FOLLOWING),this.introAnimation.transitions;case J.RACING:return A.player.update(i),this.updateTerrainSound(),this.trackMarks.update(),A.collectedItems+=A.items.handleItemCollection(),-A.player.position[2]>=A.courseConfig.playLength&&(A.endTime=Date.now(),A.courseConfig.showOutro?(A.player.saveFinishSpeed(),A.state=J.BREAKING):(this.musicPlayer.fadeOut(500),A.state=J.TERMINATED)),A.player.transitions;case J.BREAKING:return A.player.update(i),this.updateTerrainSound(),this.trackMarks.update(),this.camera.incrementCameraDistance(i),A.player.speed<Dt.BREAKING_TARGET_SPEED&&(this.outroAnimation.start(),this.currentTerrain&&A.soundPlayer.stopSound(this.currentTerrain?.sound),this.musicPlayer.playWinningMusic(),A.state=J.OUTRO),A.player.transitions;case J.OUTRO:return this.outroAnimation.update(i),this.outroAnimation.active||(this.musicPlayer.fadeOut(500),A.state=J.TERMINATED),this.outroAnimation.transitions;default:throw new Error("Unexpected game state: "+A.state)}}updateTerrainSound(){if(A.player.isAirborne){this.currentTerrain&&(A.soundPlayer.stopSound(this.currentTerrain.sound),delete this.currentTerrain);return}const i=A.player.position,e=A.course.findTerrain(i[0],i[2]);this.currentTerrain!==e&&(this.currentTerrain?.sound&&A.soundPlayer.stopSound(this.currentTerrain.sound),e.sound&&A.soundPlayer.playSound(e.sound),this.currentTerrain=e)}}class ae{stack;index;constructor(){this.stack=[v.createIdentity()],this.index=0}get current(){return this.stack[this.index]}load(i){this.stack[this.index]=i}push(){const i=this.stack[this.index];this.stack.push([...i]),this.index++}pop(){this.stack.pop(),this.index--}loadIdentity(){this.load(v.createIdentity())}multiply(i){const e=this.stack[this.index];this.stack[this.index]=v.multiply(i,e)}}class se{keyState;constructor(){this.keyState={keyboardA:!1,keyboardD:!1,keyboardW:!1,keyboardS:!1,keyboardArrowLeft:!1,keyboardArrowRight:!1,keyboardArrowUp:!1,keyboardArrowDown:!1},document.addEventListener("keydown",i=>{this.setKeyState(i.key,!0)}),document.addEventListener("keyup",i=>{this.setKeyState(i.key,!1)})}setKeyState(i,e){switch(i.toLowerCase()){case"a":this.keyState.keyboardA=e;break;case"d":this.keyState.keyboardD=e;break;case"w":this.keyState.keyboardW=e;break;case"s":this.keyState.keyboardS=e;break;case"arrowup":this.keyState.keyboardArrowUp=e;break;case"arrowdown":this.keyState.keyboardArrowDown=e;break;case"arrowleft":this.keyState.keyboardArrowLeft=e;break;case"arrowright":this.keyState.keyboardArrowRight=e;break}}}class et{static INNER_RADIUS=42*window.devicePixelRatio;static OUTER_RADIUS=59*window.devicePixelRatio;static KNOB_RADIUS=25*window.devicePixelRatio;static COLOR_BLACK="#00000090";static COLOR_GREEN="#00800090";static COLOR_RED="#ff000090";canvasElement;context;borderImage;isTouchActive=!1;centerX;centerY;pointerX;pointerY;touchState;constructor(){this.canvasElement=document.getElementById("game-touch-stick-canvas"),this.context=this.canvasElement.getContext("2d"),this.borderImage=this.createBorderImage(),this.touchState={stickAngle:void 0,isPointingForward:!1,isPointingBackward:!1},document.addEventListener("touchstart",i=>{i.touches.length===1&&this.onTouchStart(i.touches[0].clientX,i.touches[0].clientY),i.preventDefault()},{passive:!1}),document.addEventListener("touchmove",i=>{i.touches.length===1&&this.onTouchMove(i.touches[0].clientX,i.touches[0].clientY),i.preventDefault()},{passive:!1}),document.addEventListener("touchend",i=>{this.onTouchEnd(),i.preventDefault()},{passive:!1}),document.addEventListener("touchcancel",i=>{this.onTouchEnd(),i.preventDefault()},{passive:!1}),document.addEventListener("mousedown",i=>{this.onTouchStart(i.x,i.y)}),document.addEventListener("mousemove",i=>{this.onTouchMove(i.x,i.y)}),document.addEventListener("mouseup",()=>{this.onTouchEnd()})}update(i,e){const o=i-this.centerX,r=e-this.centerY,_=Math.hypot(o,r),c=-Math.atan2(o,r)+w.PI_0_5;if(this.touchState.stickAngle=c+w.PI_0_5,_<et.INNER_RADIUS)this.pointerX=i,this.pointerY=e,this.touchState.isPointingBackward=!1,this.touchState.isPointingForward=!1;else{const T=Math.sin(c);this.touchState.isPointingForward=T<0,this.touchState.isPointingBackward=T>=0;const p=Math.min(et.OUTER_RADIUS,_);this.pointerX=this.centerX+Math.cos(c)*p,this.pointerY=this.centerY+T*p}}draw(){this.isTouchActive&&(this.resize(),this.clear(),this.context.drawImage(this.borderImage,this.centerX-this.borderImage.width/2,this.centerY-this.borderImage.height/2),this.context.fillStyle=this.touchState.isPointingForward?et.COLOR_GREEN:this.touchState.isPointingBackward?et.COLOR_RED:et.COLOR_BLACK,this.context.beginPath(),this.context.arc(this.pointerX,this.pointerY,et.KNOB_RADIUS,0,w.PI_2),this.context.fill())}clear(){this.context.clearRect(0,0,this.canvasElement.width,this.canvasElement.height)}resize(){const i=window.devicePixelRatio,{width:e,height:o}=this.canvasElement.getBoundingClientRect(),r=Math.round(e*i),_=Math.round(o*i);(this.canvasElement.width!=r||this.canvasElement.height!=_)&&(this.canvasElement.width=r,this.canvasElement.height=_)}createBorderImage(){const i=2*et.OUTER_RADIUS+6,e=i/2,o=new OffscreenCanvas(i,i),r=o.getContext("2d");return r.lineWidth=2,r.strokeStyle=et.COLOR_BLACK,r.beginPath(),r.arc(e,e,et.INNER_RADIUS,0,w.PI_2),r.stroke(),r.lineWidth=4,r.strokeStyle=et.COLOR_RED,r.beginPath(),r.arc(e,e,et.OUTER_RADIUS,0,Math.PI),r.stroke(),r.strokeStyle=et.COLOR_GREEN,r.beginPath(),r.arc(e,e,et.OUTER_RADIUS,Math.PI,0),r.stroke(),o.transferToImageBitmap()}onTouchStart(i,e){this.isTouchActive||(this.isTouchActive=!0,i*=window.devicePixelRatio,e*=window.devicePixelRatio,this.centerX=i,this.centerY=e,this.update(i,e))}onTouchMove(i,e){this.isTouchActive&&(i*=window.devicePixelRatio,e*=window.devicePixelRatio,this.update(i,e))}onTouchEnd(){this.isTouchActive=!1,this.touchState.stickAngle=void 0,this.clear()}}var Et;(s=>{s.BUNNY_HILL={key:"bunny-hill",width:90,length:520,playWidth:85,playLength:470,startX:45,startY:-3.5,angle:25,scale:7,finishBrake:15,showOutro:!0,fogHeight:.25},s.FROZEN_RIVER={key:"frozen-river",width:100,length:800,playWidth:60,playLength:785,startX:50,startY:-3.5,angle:32,scale:18,finishBrake:25,showOutro:!1,fogHeight:.35},s.CHALLENGE_ONE={key:"challenge-one",width:100,length:1500,playWidth:95,playLength:1485,startX:50,startY:-3,angle:28,scale:20,finishBrake:25,showOutro:!0,fogHeight:.35},s.CHINESE_WALL={key:"chinese-wall",width:100,length:1500,playWidth:95,playLength:1485,startX:50,startY:-3,angle:30,scale:12,finishBrake:25,showOutro:!0,fogHeight:.35},s.DOWNHILL_FEAR={key:"downhill-fear",width:60,length:1800,playWidth:60,playLength:1800,startX:30,startY:-3.5,angle:24,scale:7,finishBrake:25,showOutro:!1,fogHeight:.35},s.EXPLORE_MOUNTAINS={key:"explore-mountains",width:100,length:2e3,playWidth:95,playLength:1980,startX:50,startY:-3,angle:25,scale:12,finishBrake:25,showOutro:!0,fogHeight:.2},s.FROZEN_LAKES={key:"frozen-lakes",width:100,length:2e3,playWidth:95,playLength:1980,startX:50,startY:-3,angle:25,scale:12,finishBrake:25,showOutro:!0,fogHeight:.35},s.HIPPO_RUN={key:"hippo-run",width:30,length:3500,playWidth:30,playLength:3495,startX:16,startY:-3.5,angle:25,scale:13.5,finishBrake:25,showOutro:!1,fogHeight:.25},s.HOLY_GRAIL={key:"holy-grail",width:100,length:1500,playWidth:95,playLength:1485,startX:50,startY:-3,angle:25,scale:22,finishBrake:25,showOutro:!0,fogHeight:.25},s.IN_SEARCH_OF_VODKA={key:"in-search-of-vodka",width:60,length:2500,playWidth:60,playLength:2500,startX:30,startY:-3.5,angle:25,scale:10,finishBrake:25,showOutro:!1,fogHeight:.25},s.MILOS_CASTLE={key:"milos-castle",width:54,length:800,playWidth:54,playLength:800,startX:20,startY:-5,angle:23,scale:15,finishBrake:25,showOutro:!1,fogHeight:.25},s.PATH_OF_DAGGERS={key:"path-of-daggers",width:54,length:800,playWidth:48,playLength:795,startX:45,startY:-3,angle:23,scale:12,finishBrake:25,showOutro:!1,fogHeight:.25},s.PENGUINS_CANT_FLY={key:"penguins-cant-fly",width:60,length:2500,playWidth:60,playLength:2500,startX:30,startY:-3.5,angle:30,scale:10,finishBrake:25,showOutro:!1,fogHeight:.25},s.QUIET_RIVER={key:"quiet-river",width:50,length:2e3,playWidth:49,playLength:2e3,startX:20,startY:-3,angle:25,scale:12,finishBrake:25,showOutro:!1,fogHeight:.25},s.SECRET_VALLEYS={key:"secret-valleys",width:100,length:2e3,playWidth:95,playLength:1980,startX:50,startY:-3,angle:25,scale:12,finishBrake:25,showOutro:!0,fogHeight:.25},s.THIS_MEANS_SOMETHING={key:"this-means-something",width:54,length:800,playWidth:52,playLength:800,startX:30,startY:-3,angle:23,scale:36,finishBrake:25,showOutro:!1,fogHeight:.25},s.TUX_AT_HOME={key:"tux-at-home",width:100,length:2e3,playWidth:95,playLength:1980,startX:50,startY:-3,angle:25,scale:15,finishBrake:25,showOutro:!0,fogHeight:.25},s.TWISTY_SLOPE={key:"twisty-slope",width:90,length:520,playWidth:55,playLength:470,startX:45,startY:-3.5,angle:25,scale:7,finishBrake:15,showOutro:!0,fogHeight:.25},s.WILD_MOUNTAINS={key:"wild-mountains",width:100,length:2e3,playWidth:95,playLength:1980,startX:50,startY:-3,angle:28,scale:15,finishBrake:15,showOutro:!0,fogHeight:.25},s.BUMPY_RIDE={key:"bumpy-ride",width:60,length:604,playWidth:30,playLength:550,startX:30,startY:-3.1,angle:30,scale:8,finishBrake:15,showOutro:!0,fogHeight:.25},s.ALL=[s.BUNNY_HILL,s.BUMPY_RIDE,s.DOWNHILL_FEAR,s.QUIET_RIVER,s.TWISTY_SLOPE,s.THIS_MEANS_SOMETHING,s.FROZEN_RIVER,s.IN_SEARCH_OF_VODKA,s.FROZEN_LAKES,s.HIPPO_RUN,s.PENGUINS_CANT_FLY,s.SECRET_VALLEYS,s.MILOS_CASTLE,s.HOLY_GRAIL,s.EXPLORE_MOUNTAINS,s.TUX_AT_HOME,s.WILD_MOUNTAINS,s.CHINESE_WALL,s.CHALLENGE_ONE,s.PATH_OF_DAGGERS],s.BY_KEY=new Map(s.ALL.map(i=>[i.key,i]))})(Et||(Et={}));var It;(s=>{s.SUNNY={key:"sunny",fog:{start:40,end:75,color:[1,1,1,1]},lights:[{ambientColor:[.45,.53,.75,1],diffuseColor:[1,.9,1,1],specularColor:[0,0,0,0],position:[1,1,0]},{ambientColor:[0,0,0,0],diffuseColor:[.3,.3,.3,1],specularColor:[.8,.8,.8,1],position:[-1,1,2]}],particleColor:[.85,.9,1,1],skyboxTexture:"sunny.webp"},s.NIGHT={key:"night",fog:{start:0,end:75,color:[0,.09,.34,1]},lights:[{ambientColor:[0,.09,.34,1],diffuseColor:[.39,.51,.88,1],specularColor:[.1,.1,.1,1],position:[1,1,1]}],particleColor:[.39,.51,.88,1],skyboxTexture:"night.webp"},s.CLOUDY={key:"cloudy",fog:{start:-10,end:80,color:[.58,.59,.65,1]},lights:[{ambientColor:[.39,.4,.44,1],diffuseColor:[.45,.43,.47,1],specularColor:[0,0,0,0],position:[1,1,1]},{ambientColor:[0,0,0,0],diffuseColor:[0,0,0,0],specularColor:[.5,.5,.5,1],position:[1,1,2]}],particleColor:[.92,.88,1,1],skyboxTexture:"cloudy.webp"},s.ALL=[s.SUNNY,s.CLOUDY,s.NIGHT],s.BY_KEY=new Map(s.ALL.map(i=>[i.key,i]))})(It||(It={}));class lt{static COS_PI_0_75=Math.cos(w.PI_0_75);static SIN_PI_0_75=Math.sin(w.PI_0_75);static COS_PI_1_75=Math.cos(w.PI_1_75);static SIN_PI_1_75=Math.sin(w.PI_1_75);static DISPLAY_SPEED_FACTOR=3.6;timeMinutesElement;timeSecondsElement;timeDecisecondsElement;pointsElement;speedElement;speedCanvasElement;speedRenderingContext;gaugeBorderImage;gaugeGradient;constructor(){this.pointsElement=document.getElementById("game-points"),this.timeMinutesElement=document.getElementById("game-time-minutes"),this.timeSecondsElement=document.getElementById("game-time-seconds"),this.timeDecisecondsElement=document.getElementById("game-time-deciseconds"),this.speedElement=document.getElementById("game-speed-text"),this.speedCanvasElement=document.getElementById("game-speed-canvas"),this.speedRenderingContext=this.speedCanvasElement.getContext("2d"),this.resizeSpeedCanvas(),this.gaugeBorderImage=this.createGaugeBorderImage(),this.gaugeGradient=this.createGaugeGradient()}updateHud(){this.resizeSpeedCanvas(),this.drawGauge(),this.updateTime(),this.pointsElement.innerText=A.collectedItems.toString().padStart(3,"0")}resizeSpeedCanvas(){const i=this.speedCanvasElement,e=window.devicePixelRatio,{width:o,height:r}=i.getBoundingClientRect(),_=Math.round(o*e),c=Math.round(r*e);(i.width!=_||i.height!=c)&&(i.width=_,i.height=c,this.gaugeBorderImage=this.createGaugeBorderImage(),this.gaugeGradient=this.createGaugeGradient())}drawGauge(){const i=A.state===J.RACING||A.state===J.BREAKING?A.player.speed:0,e=Math.floor(i*lt.DISPLAY_SPEED_FACTOR);this.speedElement.innerText=e.toString().padStart(3,"0");const o=w.PI_0_75+Math.min(Math.PI,i*.025*Math.PI),r=this.speedCanvasElement,_=this.speedRenderingContext,c=r.width,T=c/2;_.clearRect(0,0,c,c),_.lineWidth=T*.25,_.strokeStyle=this.gaugeGradient,_.beginPath(),_.arc(T,T,T*.875,w.PI_0_75,o),_.stroke(),_.drawImage(this.gaugeBorderImage,0,0)}updateTime(){let i=(A.endTime??Date.now())-(A.startTime??Date.now());const e=Math.floor(i/ut.ONE_MINUTE_IN_MILLISECONDS);i-=e*ut.ONE_MINUTE_IN_MILLISECONDS;const o=Math.floor(i/ut.ONE_SECOND_IN_MILLISECONDS);i-=o*ut.ONE_SECOND_IN_MILLISECONDS;const r=Math.floor(i/ut.ONE_DECISECOND_IN_MILLISECONDS);this.timeMinutesElement.innerText=e.toString().padStart(2,"0"),this.timeSecondsElement.innerText=o.toString().padStart(2,"0"),this.timeDecisecondsElement.innerText=r.toString().padStart(2,"0")}createGaugeBorderImage(){const i=this.speedCanvasElement.width,e=i/2,o=e*.75,r=e-2,_=new OffscreenCanvas(i,i),c=_.getContext("2d");return c.strokeStyle="black",c.lineWidth=2,c.beginPath(),c.arc(e,e,r,w.PI_0_75,w.PI_1_75),c.stroke(),c.beginPath(),c.arc(e,e,o,0,w.PI_2),c.stroke(),c.beginPath(),c.moveTo(e+o*lt.COS_PI_0_75,e+o*lt.SIN_PI_0_75),c.lineTo(e+r*lt.COS_PI_0_75,e+r*lt.SIN_PI_0_75),c.stroke(),c.beginPath(),c.moveTo(e+o*lt.COS_PI_1_75,e+o*lt.SIN_PI_1_75),c.lineTo(e+r*lt.COS_PI_1_75,e+r*lt.SIN_PI_1_75),c.stroke(),_.transferToImageBitmap()}createGaugeGradient(){const i=this.speedCanvasElement.width/2,e=this.speedRenderingContext.createConicGradient(w.PI_0_75,i,i);return e.addColorStop(0,"green"),e.addColorStop(.4,"yellow"),e.addColorStop(.5,"red"),e}}const ce=fe(),le=he(),dt=document.getElementById("game-canvas"),jt=dt.getContext("webgl2");y.gl=jt;y.modelViewMatrix=new ae;const ue=new lt,de=new se,Kt=new et,Jt=new Dt;await Jt.init(ce,le);pe();let kt=0;requestAnimationFrame(zt);function zt(s){if(kt!==0){const i=s-kt;if(_e(),Jt.update(i/ut.ONE_SECOND_IN_MILLISECONDS,de.keyState,Kt.touchState),Kt.draw(),ue.updateHud(),A.state===J.TERMINATED){Qt();return}}kt=s,requestAnimationFrame(zt)}function _e(){const s=window.devicePixelRatio,{width:i,height:e}=dt.getBoundingClientRect(),o=Math.round(i*s),r=Math.round(e*s);(dt.width!=o||dt.height!=r)&&(dt.width=o,dt.height=r,jt.viewport(0,0,dt.width,dt.height),y.perspectiveMatrix=v.createPerspectiveMatrix(pt.FIELD_OF_VIEW,dt.width/dt.height,pt.NEAR_CLIPPING_DISTANCE,pt.FAR_CLIPPING_DISTANCE+pt.FAR_CLIPPING_FUDGE_AMOUNT))}function fe(){const i=new URLSearchParams(window.location.search).get("course");return!i||!Et.BY_KEY.has(i)?Et.BUNNY_HILL:Et.BY_KEY.get(i)}function he(){const i=new URLSearchParams(window.location.search).get("environment");return!i||!It.BY_KEY.has(i)?It.SUNNY:It.BY_KEY.get(i)}function pe(){const s=document.getElementById("loading-screen");s.classList.add("faded-out"),setTimeout(()=>s.classList.add("hidden"),300)}function Qt(s=!1){if(new URLSearchParams(window.location.search).has("menu")){let e="";if(!s){const o=(A.endTime??0)-(A.startTime??0),r=btoa(JSON.stringify({course:A.courseConfig.key,time:o}));e="?result="+encodeURIComponent(r)}setTimeout(()=>window.location.href=`../index.html${e}#/practise`,500)}else{const e=Math.floor(Et.ALL.length*Math.random()),o=Et.ALL[e].key,r=Math.floor(It.ALL.length*Math.random()),_=It.ALL[r].key;setTimeout(()=>window.location.href=`./index.html?course=${o}&environment=${_}`,500)}}document.addEventListener("keydown",s=>{const i=s.key.toLowerCase();i==="escape"?Qt(!0):i==="r"&&window.location.reload()});
